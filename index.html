<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiDrishti AI | Intelligent Agriculture</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Outfit for a modern, tech feel -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: '#2F855A', // Green-700
                        secondary: '#2B6CB0', // Blue-700
                        accent: '#D69E2E', // Yellow-600
                        danger: '#C53030', // Red-700
                    }
                }
            }
        }
    </script>
    <script>
        // Theme Initialization
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet.js for OpenStreetMap (Free, No API Key Required) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .active-tab {
            border-bottom: 3px solid #2F855A;
            color: #10B981;
            /* Emerald-500 for better pop */
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .card-interactive {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-interactive:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 0 20px rgba(45, 212, 191, 0.3);
            border-color: rgba(45, 212, 191, 0.5);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }


        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }

        /* Map Pulse Animation */
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* Staggered Slide Animations */
        .slide-up {
            opacity: 0;
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .delay-100 {
            animation-delay: 0.1s;
        }

        .delay-200 {
            animation-delay: 0.2s;
        }

        .delay-300 {
            animation-delay: 0.3s;
        }

        .delay-400 {
            animation-delay: 0.4s;
        }
    </style>
</head>

<body
    class="bg-slate-50 text-slate-800 font-sans dark:bg-black dark:bg-[radial-gradient(circle_at_50%_-20%,_#1e293b,_#000)] dark:text-gray-100 transition-colors duration-300 selection:bg-cyan-500/30">

    <!-- Login Overlay -->
    <div id="login-overlay"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-black transition-opacity duration-500">
        <div
            class="bg-white/10 backdrop-blur-xl p-8 rounded-2xl border border-white/10 shadow-2xl w-full max-w-md text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-b from-cyan-500/10 to-transparent opacity-20"></div>
            <div class="relative z-10">
                <div
                    class="mb-8 inline-block p-4 rounded-full bg-cyan-500/10 border border-cyan-500/20 shadow-[0_0_30px_rgba(34,211,238,0.2)]">
                    <i class="fa-solid fa-leaf text-cyan-400 text-4xl animate-pulse"></i>
                </div>
                <h1 class="text-4xl font-bold text-white tracking-tight mb-2">KrishiDrishti <span
                        class="text-cyan-400">AI</span></h1>
                <p class="text-slate-400 mb-8 font-light">Intelligent Agriculture Dashboard</p>
                <button onclick="enterApp()"
                    class="group w-full bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 border border-cyan-500/50 py-3.5 rounded-xl font-semibold transition-all duration-300 hover:scale-[1.02] hover:shadow-[0_0_20px_rgba(34,211,238,0.3)] flex items-center justify-center gap-2">
                    <span>ENTER SYSTEM</span>
                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav
        class="glass-panel sticky top-0 z-50 border-b border-slate-200/50 dark:border-white/5 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div
                        class="bg-gradient-to-br from-green-400 to-cyan-500 p-2 rounded-lg mr-3 shadow-lg shadow-green-500/20">
                        <i class="fa-solid fa-leaf text-white text-xl"></i>
                    </div>
                    <span class="font-bold text-2xl text-slate-900 tracking-tight dark:text-white">KrishiDrishti <span
                            class="text-primary dark:text-cyan-400">AI</span></span>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Desktop Menu -->
                    <div class="hidden md:flex space-x-8">
                        <button onclick="switchTab('dashboard')" id="tab-dashboard"
                            class="active-tab px-3 py-5 text-sm font-medium transition-all hover:scale-105 dark:text-slate-300 dark:hover:text-cyan-400">Dashboard</button>
                        <button onclick="switchTab('spoilage')" id="tab-spoilage"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-all hover:scale-105 dark:text-slate-400 dark:hover:text-cyan-400">Spoilage
                            Risk</button>
                        <button onclick="switchTab('market')" id="tab-market"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-all hover:scale-105 dark:text-slate-400 dark:hover:text-cyan-400">Market
                            Intel</button>
                        <button onclick="switchTab('soil')" id="tab-soil"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-all hover:scale-105 dark:text-slate-400 dark:hover:text-cyan-400">Soil
                            Health</button>
                        <button onclick="switchTab('rotation')" id="tab-rotation"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-all hover:scale-105 dark:text-slate-400 dark:hover:text-cyan-400">Rotation
                            Plan</button>
                        <button onclick="switchTab('disease')" id="tab-disease"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-all hover:scale-105 dark:text-slate-400 dark:hover:text-cyan-400">Disease
                            Detect</button>
                    </div>

                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme(event)"
                        class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-cyan-400 dark:hover:bg-white/5 transition-colors focus:outline-none">
                        <i class="fa-solid fa-moon dark:hidden"></i>
                        <i class="fa-solid fa-sun hidden dark:block"></i>
                    </button>

                    <!-- Mobile Menu Button -->
                    <div class="flex items-center md:hidden">
                        <button onclick="toggleMobileMenu()"
                            class="text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
                            <i class="fa-solid fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu"
            class="hidden md:hidden bg-white border-t px-4 py-2 shadow-lg dark:bg-slate-800 dark:border-slate-700">
            <button onclick="switchTab('dashboard')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Dashboard</button>
            <button onclick="switchTab('spoilage')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Spoilage Risk</button>
            <button onclick="switchTab('market')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Market
                Intel</button>
            <button onclick="switchTab('soil')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Soil
                Health</button>
            <button onclick="switchTab('rotation')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Rotation
                Plan</button>
            <button onclick="switchTab('disease')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Disease Detect</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- DASHBOARD SECTION -->
        <section id="view-dashboard" class="fade-in">
            <div class="mb-8 flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Farm Overview</h1>
                    <p class="text-slate-500 mt-1 dark:text-slate-400">"The farmer has to be an optimist or he wouldn't
                        still be a farmer." ‚Äî Will Rogers
                    </p>
                    <div class="flex items-center gap-2 mt-2 text-sm text-slate-600 dark:text-slate-400">
                        <i class="fa-solid fa-location-dot text-cyan-500 animate-bounce"></i>
                        <span id="dashLocationText">Delhi, India</span>
                        <button onclick="toggleLocationMap()"
                            class="text-cyan-600 hover:underline dark:text-cyan-400 font-medium">
                            Change
                        </button>
                    </div>
                </div>
                <button onclick="toggleLocationMap()"
                    class="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-all hover:shadow-lg hover:shadow-cyan-500/20 flex items-center gap-2 border border-slate-700 dark:bg-cyan-500/10 dark:text-cyan-400 dark:border-cyan-500/50 dark:hover:bg-cyan-500/20">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <span>Set Location</span>
                </button>
            </div>

            <!-- AI COMMAND CENTER (New Feature) -->
            <div
                class="mb-8 relative overflow-hidden rounded-2xl bg-white border border-slate-200 shadow-xl dark:bg-gradient-to-r dark:from-slate-900 dark:to-slate-800 dark:border-none dark:shadow-cyan-900/20 slide-up">
                <div class="absolute inset-0 bg-[url('https://grain-texture.com/grain.png')] opacity-10"></div>
                <div
                    class="relative bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl rounded-xl p-6 md:p-8 flex flex-col md:flex-row items-center justify-between gap-6 border border-slate-100 dark:border-white/10">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span
                                class="px-3 py-1 rounded-full bg-cyan-100 text-cyan-700 dark:bg-cyan-500/20 dark:text-cyan-400 text-xs font-bold border border-cyan-200 dark:border-cyan-500/30 animate-pulse">AI
                                DECISION MATRIX</span>
                            <span class="text-slate-500 dark:text-slate-400 text-xs">Updated: Just now</span>
                        </div>
                        <h2 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-2">Recommendation:
                            <span
                                class="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-700 dark:from-green-400 dark:to-emerald-600">STORE
                                CROP</span>
                        </h2>
                        <p class="text-slate-600 dark:text-slate-400 text-sm md:text-base max-w-xl">
                            Market prices are projected to rise by <span
                                class="text-green-600 dark:text-green-400 font-bold">8.5%</span> in the next 14 days.
                            Spoilage risk is low.
                            <br>Logistics availability is high for next week.
                        </p>
                    </div>
                    <div class="flex gap-4">
                        <div
                            class="text-center px-6 py-4 bg-slate-50 dark:bg-white/5 rounded-xl border border-slate-200 dark:border-white/10">
                            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider">Confidence
                            </p>
                            <p class="text-2xl font-bold text-slate-800 dark:text-white">94%</p>
                        </div>
                        <div
                            class="text-center px-6 py-4 bg-slate-50 dark:bg-white/5 rounded-xl border border-slate-200 dark:border-white/10">
                            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider">Potential
                                Gain</p>
                            <p class="text-2xl font-bold text-green-600 dark:text-green-400">+‚Çπ12k</p>
                        </div>
                    </div>
                    <button onclick="switchTab('predictions')"
                        class="group px-6 py-4 bg-cyan-600 hover:bg-cyan-500 text-white dark:bg-cyan-500 dark:hover:bg-cyan-400 dark:text-slate-900 font-bold rounded-xl transition-all shadow-lg hover:shadow-cyan-500/40 flex items-center gap-2">
                        <span>VIEW ANALYSIS</span>
                        <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 slide-up delay-100">
                <!-- Stat 1 -->
                <div onclick="switchTab('soil')"
                    class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100 card-interactive cursor-pointer">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-500 text-sm font-medium dark:text-slate-400">Avg. Soil Nitrogen</p>
                            <h3 class="text-3xl font-bold mt-2 text-slate-900 dark:text-white">
                                <span id="dashNitrogenValue">142</span> <span
                                    class="text-sm font-normal text-slate-400">kg/ha</span>
                            </h3>
                        </div>
                        <div
                            class="p-3 rounded-xl bg-green-50 text-green-600 dark:bg-emerald-500/10 dark:text-emerald-400">
                            <i class="fa-solid fa-seedling"></i>
                        </div>
                    </div>
                    <div class="flex items-center text-sm text-green-600 font-medium">
                        <i class="fa-solid fa-arrow-trend-up mr-1"></i> +12% <span
                            class="text-slate-400 font-normal ml-2">vs last season</span>
                    </div>
                </div>

                <!-- Stat 2 -->
                <div onclick="switchTab('spoilage')"
                    class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100 card-interactive cursor-pointer">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-500 text-sm font-medium dark:text-slate-400">Spoilage Risk</p>
                            <h3 id="dashSpoilageRisk"
                                class="text-3xl font-bold mt-2 text-slate-400 dark:text-slate-500">Not Predicted</h3>
                        </div>
                        <div id="dashSpoilageIcon"
                            class="p-3 rounded-xl bg-slate-50 text-slate-400 dark:bg-slate-500/10 dark:text-slate-500">
                            <i class="fa-solid fa-question"></i>
                        </div>
                    </div>
                    <div id="dashSpoilageDetail" class="flex items-center text-sm text-slate-500 font-medium">
                        <i class="fa-solid fa-info-circle mr-1"></i> Run prediction to see risk <span
                            class="text-slate-400 font-normal ml-2">Spoilage tab</span>
                    </div>
                </div>

                <!-- Stat 3 -->
                <div onclick="switchTab('market')"
                    class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100 card-interactive cursor-pointer">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p id="dashMarketTitle" class="text-slate-500 text-sm font-medium dark:text-slate-400">
                                Market Price (Wheat)</p>
                            <h3 class="text-3xl font-bold mt-2 text-slate-900 dark:text-white"><span
                                    id="dashMarketPrice">‚Çπ2,150</span> <span
                                    class="text-sm font-normal text-slate-400">/q</span></h3>
                        </div>
                        <div
                            class="p-3 rounded-xl bg-yellow-50 text-yellow-600 dark:bg-purple-500/10 dark:text-purple-400">
                            <i class="fa-solid fa-indian-rupee-sign"></i>
                        </div>
                    </div>
                    <div class="flex items-center text-sm text-green-600 font-medium">
                        <i class="fa-solid fa-arrow-trend-up mr-1"></i> +5.4% <span
                            class="text-slate-400 font-normal ml-2">vs last week</span>
                    </div>
                </div>

                <!-- Stat 4 -->
                <div onclick="switchTab('soil')"
                    class="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 card-interactive cursor-pointer dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-500 text-sm font-medium dark:text-slate-400">Next Harvest</p>
                            <h3 class="text-3xl font-bold mt-2 text-slate-900 dark:text-white">14 Days</h3>
                        </div>
                        <div class="p-3 rounded-xl bg-blue-50 text-blue-600 dark:bg-cyan-500/10 dark:text-cyan-400">
                            <i class="fa-regular fa-calendar"></i>
                        </div>
                    </div>
                    <div class="flex items-center text-sm text-blue-600 font-medium">
                        <i class="fa-solid fa-check mr-1"></i> On Schedule
                    </div>
                </div>
            </div>

            <!-- Local Cold Storage Facilities -->
            <div
                class="mb-8 bg-white p-6 rounded-2xl shadow-soft border border-slate-100 dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10 slide-up delay-200">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg dark:text-white">üè≠ Nearby Cold Storage Facilities
                        </h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                            <i class="fa-solid fa-location-dot text-green-600 dark:text-green-400"></i>
                            <span id="coldStorageLocation">Delhi Region</span>
                        </p>
                    </div>
                    <span
                        class="text-xs font-semibold px-3 py-1 bg-blue-100 rounded-full text-blue-600 dark:bg-blue-500/10 dark:text-blue-400">
                        <span id="coldStorageCount">3</span> Facilities
                    </span>
                </div>

                <!-- Cold Storage Cards Grid -->
                <div id="coldStorageGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="col-span-1 md:col-span-3 text-center py-12">
                        <i class="fa-solid fa-circle-notch fa-spin text-slate-300 text-3xl mb-3"></i>
                        <p class="text-slate-500">Locating nearest storage facilities...</p>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 slide-up delay-300">
                <!-- Spoilage Heatmap / Chart -->
                <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-800 text-lg dark:text-white">Storage Conditions History</h3>
                        <span
                            class="text-xs font-semibold px-3 py-1 bg-slate-100 rounded-full text-slate-600 dark:bg-white/5 dark:text-slate-300">Last
                            7
                            Days</span>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="storageChart"></canvas>
                    </div>
                </div>

                <!-- Market Price Forecast -->
                <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="dashMarketChartTitle" class="font-bold text-slate-800 text-lg dark:text-white">Wheat
                            Price Forecast</h3>
                        <span
                            class="text-xs font-semibold px-3 py-1 bg-green-100 text-green-800 rounded-full dark:bg-emerald-500/10 dark:text-emerald-400">Bullish
                            Trend</span>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="marketChartDashboard"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SPOILAGE PREDICTION SECTION -->
        <section id="view-spoilage" class="hidden fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Spoilage Risk Prediction</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">Analyze storage conditions to prevent crop loss using
                    AI.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Input Form -->
                <div
                    class="lg:col-span-1 glass-panel p-6 rounded-2xl shadow-sm border border-slate-100 h-fit card-interactive">
                    <h2
                        class="font-semibold text-lg mb-6 text-slate-800 border-b border-slate-100 pb-4 dark:text-white dark:border-white/5">
                        Input Parameters</h2>
                    <form onsubmit="predictSpoilage(event)" class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Crop
                                Type</label>
                            <input list="cropOptions" id="cropType" placeholder="Search or select crop..."
                                class="w-full rounded-xl border-slate-200 border p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none bg-slate-50 transition-all dark:bg-black/40 dark:border-white/10 dark:text-white dark:focus:ring-cyan-500/50 dark:focus:border-cyan-500"
                                required>
                            <datalist id="cropOptions"></datalist>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Temp
                                    (¬∞C)</label>
                                <input type="number" id="tempInput" value="28" min="-10" max="60" step="0.1"
                                    class="w-full rounded-xl border-slate-200 border p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-slate-800 dark:border-slate-700 dark:text-white"
                                    required title="Temperature must be between -10¬∞C and 60¬∞C">
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Humidity
                                    (%)</label>
                                <input type="number" id="humidityInput" value="65" min="0" max="100" step="1"
                                    class="w-full rounded-xl border-slate-200 border p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-slate-800 dark:border-slate-700 dark:text-white"
                                    required title="Humidity must be between 0% and 100%">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Storage
                                Duration (Days)</label>
                            <input type="number" id="durationInput" value="15" min="1" max="365" step="1"
                                class="w-full rounded-xl border-slate-200 border p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-slate-800 dark:border-slate-700 dark:text-white"
                                required title="Storage duration must be between 1 and 365 days">
                        </div>

                        <button type="submit"
                            class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3.5 rounded-xl hover:shadow-lg hover:shadow-green-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] font-bold tracking-wide">
                            Predict Risk
                        </button>
                    </form>
                </div>

                <!-- Results Panel -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Score Card -->
                    <div id="predictionResult"
                        class="glass-panel border-2 border-dashed border-slate-200 p-12 rounded-2xl text-center flex flex-col items-center justify-center h-64 transition-all shadow-sm card-interactive">
                        <div class="bg-slate-50 p-4 rounded-full mb-4 dark:bg-white/5">
                            <i class="fa-solid fa-flask text-3xl text-slate-400"></i>
                        </div>
                        <h3 class="text-xl font-medium text-slate-500 dark:text-slate-400">Run prediction to see results
                        </h3>
                        <p class="text-sm text-slate-400 mt-2">AI model will analyze spoilage probability based on
                            biological markers.</p>
                    </div>

                    <!-- Recommendation Card (Hidden initially) -->
                    <div id="aiRecommendation"
                        class="hidden bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 p-6 rounded-2xl flex items-start gap-4 fade-in shadow-sm dark:from-cyan-900/20 dark:to-blue-900/20 dark:border-cyan-500/30">
                        <div
                            class="bg-blue-100 p-3 rounded-full text-blue-600 mt-1 shrink-0 dark:bg-cyan-500/20 dark:text-cyan-400">
                            <i class="fa-solid fa-lightbulb"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg dark:text-white">AI Strategic Recommendation
                            </h4>
                            <p id="recText" class="text-slate-600 text-sm mt-2 leading-relaxed dark:text-slate-300">
                                Humidity levels are critical. Recommend
                                installing dehumidifiers or selling 40% of stock within 7 days.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- DISEASE DETECTION SECTION (New) -->
        <section id="view-disease" class="hidden fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">AI Crop Disease Doctor</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">Upload a photo or select symptoms for instant
                    diagnosis and treatment plans.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Input Panel -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Image Upload -->
                    <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100 card-interactive">
                        <h3 class="font-bold text-slate-800 mb-4 dark:text-white flex items-center gap-2">
                            <i class="fa-solid fa-camera text-blue-500"></i> Visual Diagnosis
                        </h3>
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8 text-center hover:bg-slate-50 dark:hover:bg-white/5 transition-colors relative group cursor-pointer"
                            onclick="document.getElementById('diseaseImageInput').click()">
                            <input type="file" id="diseaseImageInput" class="hidden" accept="image/*"
                                onchange="previewDiseaseImage(event)">
                            <div id="uploadPlaceholder">
                                <div
                                    class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                                </div>
                                <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Click to upload leaf
                                    photo</p>
                                <p class="text-xs text-slate-400 mt-1">Supports JPG, PNG</p>
                            </div>
                            <img id="diseaseImagePreview"
                                class="hidden w-full h-48 object-cover rounded-lg shadow-md" />
                            <button id="removeImageBtn" onclick="removeDiseaseImage(event)"
                                class="hidden absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 shadow-lg transition-transform hover:scale-110">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Symptom Selector -->
                    <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100 card-interactive">
                        <h3 class="font-bold text-slate-800 mb-4 dark:text-white flex items-center gap-2">
                            <i class="fa-solid fa-clipboard-list text-green-500"></i> Symptom Checker
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Select
                                    Crop</label>
                                <select id="diseaseCropSelect"
                                    class="w-full rounded-xl border-slate-200 border p-3 bg-slate-50 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-black/40 dark:border-white/10 dark:text-white">
                                    <option value="Wheat">Wheat</option>
                                    <option value="Rice">Rice</option>
                                    <option value="Potato">Potato</option>
                                    <option value="Tomato">Tomato</option>
                                    <option value="Cotton">Cotton</option>
                                    <option value="Mustard">Mustard</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Observed
                                    Symptoms</label>
                                <select id="diseaseSymptomSelect"
                                    class="w-full rounded-xl border-slate-200 border p-3 bg-slate-50 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-black/40 dark:border-white/10 dark:text-white">
                                    <option value="">-- Select Primary Symptom --</option>
                                    <option value="yellowing">Yellowing Leaves</option>
                                    <option value="spots">Brown/Black Spots</option>
                                    <option value="wilting">Wilting / Drooping</option>
                                    <option value="powder">White Powdery Coating</option>
                                    <option value="rot">Stem/Root Rot</option>
                                    <option value="curling">Leaf Curling</option>
                                </select>
                            </div>
                            <button onclick="analyzeDisease()"
                                class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3.5 rounded-xl hover:shadow-lg hover:shadow-red-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] font-bold tracking-wide flex items-center justify-center gap-2">
                                <i class="fa-solid fa-stethoscope"></i> Diagnose Now
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="lg:col-span-8">
                    <!-- Loading State -->
                    <div id="diseaseLoading"
                        class="hidden h-full flex flex-col items-center justify-center p-12 glass-panel rounded-2xl">
                        <div class="relative w-24 h-24 mb-6">
                            <div class="absolute inset-0 border-4 border-slate-200 rounded-full"></div>
                            <div
                                class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin">
                            </div>
                            <i
                                class="fa-solid fa-brain absolute inset-0 flex items-center justify-center text-3xl text-blue-500 animate-pulse"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Analyzing Crop Health...</h3>
                        <p class="text-slate-500 mt-2">Scanning for pathogens and deficiency markers.</p>
                    </div>

                    <!-- Empty State -->
                    <div id="diseaseEmpty"
                        class="h-full flex flex-col items-center justify-center p-12 glass-panel rounded-2xl border-2 border-dashed border-slate-200 dark:border-white/10">
                        <div
                            class="w-20 h-20 bg-slate-100 dark:bg-white/5 rounded-full flex items-center justify-center mb-4 text-slate-400">
                            <i class="fa-solid fa-user-doctor text-4xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-slate-600 dark:text-slate-300">Ready for Diagnosis</h3>
                        <p class="text-sm text-slate-400 max-w-xs text-center mt-1">Upload an image or select symptoms
                            to get a detailed treatment plan.</p>
                    </div>

                    <!-- Result Content -->
                    <div id="diseaseResult" class="hidden space-y-6 slide-up">
                        <!-- Diagnosis Header -->
                        <div class="glass-panel p-6 rounded-2xl border-l-8 border-red-500 shadow-sm">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <div class="flex items-center gap-3 mb-1">
                                        <span
                                            class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-bold uppercase tracking-wider dark:bg-red-900/30 dark:text-red-400">Disease
                                            Detected</span>
                                        <span class="text-sm text-slate-500 dark:text-slate-400"><i
                                                class="fa-solid fa-bullseye text-blue-500"></i> <span
                                                id="diseaseConfidence">0%</span> Confidence</span>
                                    </div>
                                    <h2 id="diseaseName" class="text-3xl font-bold text-slate-900 dark:text-white">
                                        Disease Name</h2>
                                    <p id="diseaseCause" class="text-slate-600 dark:text-slate-300 mt-1">Caused by
                                        Fungal Infection</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-slate-500 dark:text-slate-400 mb-1">Severity Level</div>
                                    <div id="diseaseSeverityBadge"
                                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-red-50 text-red-600 font-bold border border-red-100 dark:bg-red-900/20 dark:border-red-800/30 dark:text-red-400">
                                        <i class="fa-solid fa-triangle-exclamation"></i> <span
                                            id="diseaseSeverity">High</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-100 dark:border-white/10">
                                <p class="text-sm font-bold text-slate-700 dark:text-slate-300">Potential Impact:</p>
                                <p id="diseaseImpact" class="text-sm text-slate-600 dark:text-slate-400">Estimated yield
                                    loss of 20-40% if untreated within 7 days.</p>
                            </div>
                        </div>

                        <!-- Treatment Plan -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Chemical Control -->
                            <div class="glass-panel p-6 rounded-2xl border border-slate-100 relative overflow-hidden">
                                <div
                                    class="absolute top-0 right-0 w-16 h-16 bg-blue-500/10 rounded-bl-full -mr-8 -mt-8">
                                </div>
                                <h3 class="font-bold text-slate-800 mb-4 dark:text-white flex items-center gap-2">
                                    <i class="fa-solid fa-flask text-blue-500"></i> Recommended Treatment
                                </h3>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Fungicide / Pesticide
                                        </p>
                                        <p id="diseaseChemical"
                                            class="font-bold text-lg text-blue-700 dark:text-blue-400">Chemical Name</p>
                                    </div>
                                    <div
                                        class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800/30">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-sm text-slate-600 dark:text-slate-400">Dosage</span>
                                            <span id="diseaseDosage" class="font-bold text-slate-800 dark:text-white">2g
                                                / Litre</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-slate-600 dark:text-slate-400">Frequency</span>
                                            <span id="diseaseInterval"
                                                class="font-bold text-slate-800 dark:text-white">Every 7 Days</span>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Safety Precaution</p>
                                        <p id="diseasePrecaution"
                                            class="text-sm text-slate-600 dark:text-slate-300 flex items-start gap-2">
                                            <i class="fa-solid fa-shield-halved text-green-500 mt-0.5"></i> <span>Wear
                                                mask and gloves. Avoid spraying during strong sunlight.</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Organic & Steps -->
                            <div class="glass-panel p-6 rounded-2xl border border-slate-100">
                                <h3 class="font-bold text-slate-800 mb-4 dark:text-white flex items-center gap-2">
                                    <i class="fa-solid fa-leaf text-green-500"></i> Organic & Application
                                </h3>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Organic Alternative
                                        </p>
                                        <p id="diseaseOrganic" class="font-medium text-green-700 dark:text-green-400">
                                            Neem Oil Spray</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase font-bold mb-2">Application Steps</p>
                                        <ul id="diseaseSteps"
                                            class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                                            <!-- Steps injected via JS -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div
                            class="glass-panel p-6 rounded-2xl border border-slate-100 bg-gradient-to-r from-slate-50 to-white dark:from-slate-800 dark:to-slate-900">
                            <h3 class="font-bold text-slate-800 mb-4 dark:text-white">Get Solutions</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onclick="findNearbyVendors()"
                                    class="flex items-center justify-center gap-3 px-6 py-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:text-blue-600 transition-all shadow-sm group dark:bg-white/5 dark:border-white/10 dark:text-white dark:hover:border-blue-400 dark:hover:text-blue-400">
                                    <div
                                        class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center group-hover:scale-110 transition-transform dark:bg-blue-900/30">
                                        <i class="fa-solid fa-store text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <div class="text-left">
                                        <div class="font-bold text-sm">Find Local Vendors</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">Locate pesticide shops
                                            nearby</div>
                                    </div>
                                </button>

                                <button onclick="buyOnline()"
                                    class="flex items-center justify-center gap-3 px-6 py-4 bg-white border-2 border-slate-200 rounded-xl hover:border-orange-500 hover:text-orange-600 transition-all shadow-sm group dark:bg-white/5 dark:border-white/10 dark:text-white dark:hover:border-orange-400 dark:hover:text-orange-400">
                                    <div
                                        class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center group-hover:scale-110 transition-transform dark:bg-orange-900/30">
                                        <i class="fa-solid fa-cart-shopping text-orange-600 dark:text-orange-400"></i>
                                    </div>
                                    <div class="text-left">
                                        <div class="font-bold text-sm">Buy Online</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">Search Amazon / Flipkart
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MARKET INTELLIGENCE SECTION -->
        <section id="view-market" class="hidden fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Market Price Forecast</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">AI-powered 30-day price projections to optimize
                    selling timing.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- 1. Forecast Settings (Left - 3 cols) -->
                <div
                    class="lg:col-span-3 glass-panel p-5 rounded-2xl shadow-sm border border-slate-100 h-fit card-interactive">
                    <h3 class="font-bold text-slate-800 mb-4 text-lg dark:text-white flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-primary"></i> Forecast Settings
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 dark:text-slate-400">Crop
                                Selection</label>
                            <div class="relative">
                                <i class="fa-solid fa-wheat-awn absolute left-3 top-3.5 text-slate-400"></i>
                                <input list="marketCropOptions" id="marketCropSelect" onchange="updateMarketChart()"
                                    placeholder="Search crop..." value="Wheat"
                                    class="w-full pl-10 pr-4 py-3 rounded-xl border-slate-200 border bg-slate-50 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-black/40 dark:border-white/10 dark:text-white text-sm font-medium">
                            </div>
                            <datalist id="marketCropOptions"></datalist>
                        </div>

                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 dark:text-slate-400">Target
                                Mandi</label>
                            <div class="relative">
                                <i class="fa-solid fa-shop absolute left-3 top-3.5 text-slate-400"></i>
                                <select id="mandiRegionSelect" onchange="updateMarketChart()"
                                    class="w-full pl-10 pr-4 py-3 rounded-xl border-slate-200 border bg-slate-50 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-black/40 dark:border-white/10 dark:text-white text-sm font-medium appearance-none">
                                    <option disabled selected>Loading nearby mandis...</option>
                                </select>
                                <i
                                    class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-slate-400 pointer-events-none text-xs"></i>
                            </div>
                        </div>

                        <div
                            class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800/30">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium">Current
                                    Price</span>
                                <span class="font-bold text-lg text-slate-800 dark:text-white"
                                    id="currentPriceDisplay">‚Çπ2,150</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium">Predicted
                                    Peak</span>
                                <span class="font-bold text-lg text-green-600" id="peakPriceDisplay">‚Çπ2,340</span>
                            </div>
                        </div>

                        <button onclick="updateMarketChart()"
                            class="w-full bg-slate-900 text-white py-3 rounded-xl hover:bg-slate-800 transition-all font-bold text-sm shadow-lg shadow-slate-900/20 dark:bg-white dark:text-slate-900 dark:hover:bg-slate-200">
                            Update Forecast
                        </button>
                    </div>
                </div>

                <!-- 2. Location Map (Middle - 4 cols) -->
                <div
                    class="lg:col-span-4 glass-panel p-5 rounded-2xl shadow-sm border border-slate-100 h-fit card-interactive flex flex-col">
                    <h3 class="font-bold text-slate-800 mb-4 text-lg dark:text-white flex items-center gap-2">
                        <i class="fa-solid fa-map-location-dot text-blue-500"></i> Nearby Mandis
                    </h3>

                    <!-- Mini Map -->
                    <div id="mandiMiniMap"
                        class="w-full h-48 rounded-xl bg-slate-100 dark:bg-slate-800 mb-4 border border-slate-200 dark:border-white/10 relative z-0">
                    </div>

                    <!-- List -->
                    <div class="flex-1">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 dark:text-slate-400">
                            Nearest Markets</h4>
                        <div id="mandiListContainer" class="space-y-2 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                            <!-- Items injected via JS -->
                            <div class="text-center py-4 text-slate-400 text-sm">Loading location data...</div>
                        </div>
                    </div>
                </div>

                <!-- 3. Main Chart (Right - 5 cols) -->
                <div
                    class="lg:col-span-5 glass-panel p-5 rounded-2xl shadow-sm border border-slate-100 card-interactive flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800 text-lg dark:text-white">Price Trend</h3>
                        <span
                            class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-lg dark:bg-green-900/30 dark:text-green-400">30
                            Days</span>
                    </div>
                    <div class="relative h-64 w-full flex-1">
                        <canvas id="marketMainChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SOIL HEALTH SECTION -->
        <section id="view-soil" class="hidden fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Soil Health & Regeneration</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">Optimize crop rotation to restore soil nutrients.</p>
            </div>

            <div class="grid grid-cols-1 gap-8">
                <!-- Current Status -->
                <div class="glass-panel p-8 rounded-2xl shadow-sm border border-slate-100 card-interactive">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="font-bold text-slate-800 flex items-center text-lg dark:text-white">
                            <i class="fa-solid fa-flask text-primary mr-2"></i> Real-time Soil Analysis
                        </h3>
                        <a href="https://soilgrids.org/" target="_blank"
                            class="text-xs font-bold text-blue-600 hover:text-blue-500 dark:text-blue-400 flex items-center gap-1 bg-blue-50 dark:bg-blue-900/20 px-3 py-1.5 rounded-lg transition-colors">
                            <i class="fa-solid fa-external-link-alt"></i> Verify Data Source
                        </a>
                    </div>

                    <div class="space-y-6">
                        <!-- Nitrogen -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Nitrogen (N)</span>
                                <span id="soilNVal"
                                    class="text-sm font-medium text-slate-600 dark:text-slate-400">Loading...</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden dark:bg-white/10">
                                <div id="soilNBar"
                                    class="bg-slate-300 h-3 rounded-full transition-all duration-1000 ease-out"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <!-- pH Level -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Soil pH</span>
                                <span id="soilPhVal"
                                    class="text-sm font-medium text-slate-600 dark:text-slate-400">Loading...</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden dark:bg-white/10">
                                <div id="soilPhBar"
                                    class="bg-slate-300 h-3 rounded-full transition-all duration-1000 ease-out"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <!-- Organic Carbon -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Organic Carbon
                                    (SOC)</span>
                                <span id="soilSocVal"
                                    class="text-sm font-medium text-slate-600 dark:text-slate-400">Loading...</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden dark:bg-white/10">
                                <div id="soilSocBar"
                                    class="bg-slate-300 h-3 rounded-full transition-all duration-1000 ease-out"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="mt-8 p-4 bg-yellow-50 rounded-lg text-sm border-l-4 border-yellow-500 dark:bg-yellow-900/20">
                        <p class="text-yellow-800 dark:text-yellow-200"><strong>Alert:</strong> Nitrogen depletion
                            detected due to successive
                            Wheat cycles. Recommend leguminous crop rotation.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ROTATION PLAN SECTION -->
        <section id="view-rotation" class="hidden fade-in">
            <div class="mb-8 flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Crop Rotation Plan</h1>
                    <p class="text-slate-500 mt-1 dark:text-slate-400">AI-driven recommendations for sustainable
                        farming.</p>
                </div>
                <button onclick="generateRotationPlan()"
                    class="px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 hover:text-primary transition-all shadow-sm dark:bg-white/5 dark:border-white/10 dark:text-slate-300 dark:hover:text-cyan-400 flex items-center gap-2 group">
                    <i class="fa-solid fa-rotate group-hover:rotate-180 transition-transform duration-500"></i> Refresh
                    Plan
                </button>
            </div>
            <div class="glass-panel p-8 rounded-2xl shadow-sm border border-slate-100 card-interactive">
                <!-- AI Rotation Planner -->
                <h3 class="font-bold text-slate-800 mb-8 flex items-center text-lg dark:text-white">
                    <i class="fa-solid fa-rotate text-blue-600 mr-2"></i> Recommended Rotation Plan
                </h3>

                <div id="rotationPlanContainer"
                    class="relative pl-8 border-l-2 border-dashed border-slate-300 space-y-12 dark:border-white/10">
                    <!-- Content injected via JS -->
                </div>
            </div>
        </section>

        <!-- PREDICTIONS & ANALYSIS SECTION (New) -->
        <section id="view-predictions" class="hidden fade-in">
            <div class="mb-8">
                <button onclick="switchTab('dashboard')"
                    class="mb-4 flex items-center text-slate-500 hover:text-primary transition-colors">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Back to Dashboard
                </button>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Crop Profitability Analysis</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">AI-driven forecasts for the upcoming season.</p>
            </div>

            <!-- Top Recommendations Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Card 1 (Winner) -->
                <div class="glass-panel p-6 rounded-2xl border-2 border-green-500/50 relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl">
                        TOP PICK</div>
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Wheat (HD-3226)</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">High Yield Variety</p>
                        </div>
                        <div
                            class="p-3 rounded-xl bg-green-100 text-green-600 dark:bg-green-500/20 dark:text-green-400">
                            <i class="fa-solid fa-wheat-awn"></i>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600 dark:text-slate-400">Est. Profit/Acre</span>
                            <span class="font-bold text-slate-900 dark:text-white">‚Çπ24,500</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600 dark:text-slate-400">Risk Level</span>
                            <span class="font-medium text-green-600">Low</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 dark:bg-white/10 mt-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: 92%"></div>
                        </div>
                        <p class="text-xs text-right text-slate-400">92% Match</p>
                    </div>
                </div>

                <!-- Card 2 -->
                <div class="glass-panel p-6 rounded-2xl border border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Mustard</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Short Duration</p>
                        </div>
                        <div
                            class="p-3 rounded-xl bg-yellow-100 text-yellow-600 dark:bg-yellow-500/20 dark:text-yellow-400">
                            <i class="fa-solid fa-plant-wilt"></i>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600 dark:text-slate-400">Est. Profit/Acre</span>
                            <span class="font-bold text-slate-900 dark:text-white">‚Çπ21,200</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600 dark:text-slate-400">Risk Level</span>
                            <span class="font-medium text-yellow-600">Medium</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 dark:bg-white/10 mt-2">
                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 78%"></div>
                        </div>
                        <p class="text-xs text-right text-slate-400">78% Match</p>
                    </div>
                </div>

                <!-- Card 3 (New) -->
                <div class="glass-panel p-6 rounded-2xl border border-slate-100">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Chickpea</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Soil Restorer</p>
                        </div>
                        <div
                            class="p-3 rounded-xl bg-orange-100 text-orange-600 dark:bg-orange-500/20 dark:text-orange-400">
                            <i class="fa-solid fa-seedling"></i>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600 dark:text-slate-400">Est. Profit/Acre</span>
                            <span class="font-bold text-slate-900 dark:text-white">‚Çπ18,800</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600 dark:text-slate-400">Risk Level</span>
                            <span class="font-medium text-green-600">Very Low</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 dark:bg-white/10 mt-2">
                            <div class="bg-orange-500 h-2 rounded-full" style="width: 65%"></div>
                        </div>
                        <p class="text-xs text-right text-slate-400">65% Match</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Detailed Analysis Chart -->
                <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-800 text-lg mb-6 dark:text-white">Comparative Profit Forecast</h3>
                    <div class="relative h-80 w-full">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>

                <!-- Resource Comparison Table -->
                <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-800 text-lg mb-6 dark:text-white">Resource Requirement Analysis</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                            <thead
                                class="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-800 dark:text-slate-300">
                                <tr>
                                    <th class="px-4 py-3 rounded-l-lg">Crop</th>
                                    <th class="px-4 py-3">Input Cost</th>
                                    <th class="px-4 py-3">Water</th>
                                    <th class="px-4 py-3 rounded-r-lg">Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-slate-100 dark:border-white/5">
                                    <td class="px-4 py-3 font-medium text-slate-900 dark:text-white">Wheat</td>
                                    <td class="px-4 py-3">‚Çπ8,500/ac</td>
                                    <td class="px-4 py-3"><span class="text-blue-500 font-semibold">High</span></td>
                                    <td class="px-4 py-3">140 Days</td>
                                </tr>
                                <tr class="border-b border-slate-100 dark:border-white/5">
                                    <td class="px-4 py-3 font-medium text-slate-900 dark:text-white">Mustard</td>
                                    <td class="px-4 py-3">‚Çπ5,200/ac</td>
                                    <td class="px-4 py-3"><span class="text-yellow-500 font-semibold">Med</span></td>
                                    <td class="px-4 py-3">110 Days</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-3 font-medium text-slate-900 dark:text-white">Chickpea</td>
                                    <td class="px-4 py-3">‚Çπ4,800/ac</td>
                                    <td class="px-4 py-3"><span class="text-green-500 font-semibold">Low</span></td>
                                    <td class="px-4 py-3">100 Days</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div
                        class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800/50 flex items-start gap-3">
                        <i class="fa-solid fa-droplet text-blue-600 dark:text-blue-400 mt-1"></i>
                        <div>
                            <p class="text-sm font-bold text-blue-800 dark:text-blue-300">Water Availability Alert</p>
                            <p class="text-xs text-blue-700 dark:text-blue-400 mt-1">Wheat requires 4-5 irrigations.
                                Ensure canal water availability before sowing, otherwise opt for Mustard.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Plan Timeline -->
            <div class="glass-panel p-6 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 text-lg mb-6 dark:text-white">üöÄ Execution Plan for Top Pick (Wheat)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div
                        class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 relative overflow-hidden group hover:border-green-500/30 transition-colors">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-seedling text-4xl"></i></div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Phase 1: Sowing</span>
                        <p class="font-bold text-slate-800 dark:text-white mt-1 text-lg">Nov 01 - Nov 15</p>
                        <p class="text-xs text-slate-500 mt-2 leading-relaxed dark:text-slate-400">Use HD-3226 variety.
                            Seed rate: 40kg/acre. Treat seeds with fungicide.</p>
                    </div>
                    <div
                        class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 relative overflow-hidden group hover:border-blue-500/30 transition-colors">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-water text-4xl"></i></div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Phase 2:
                            Irrigation</span>
                        <p class="font-bold text-slate-800 dark:text-white mt-1 text-lg">Dec 05 - Dec 10</p>
                        <p class="text-xs text-slate-500 mt-2 leading-relaxed dark:text-slate-400">CRI stage irrigation
                            is critical for root development. Do not skip.</p>
                    </div>
                    <div
                        class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 relative overflow-hidden group hover:border-yellow-500/30 transition-colors">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-flask text-4xl"></i></div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Phase 3:
                            Nutrition</span>
                        <p class="font-bold text-slate-800 dark:text-white mt-1 text-lg">Jan 15 - Jan 20</p>
                        <p class="text-xs text-slate-500 mt-2 leading-relaxed dark:text-slate-400">Apply Urea top
                            dressing (25kg/acre) before light rain or irrigation.</p>
                    </div>
                    <div
                        class="p-4 rounded-xl bg-slate-50 dark:bg-white/5 border border-slate-100 dark:border-white/5 relative overflow-hidden group hover:border-green-500/30 transition-colors">
                        <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity"><i
                                class="fa-solid fa-sickle text-4xl"></i></div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Phase 4: Harvest</span>
                        <p class="font-bold text-slate-800 dark:text-white mt-1 text-lg">Apr 10 - Apr 20</p>
                        <p class="text-xs text-slate-500 mt-2 leading-relaxed dark:text-slate-400">Harvest when grain
                            moisture is < 12% to prevent spoilage during storage.</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- SCRIPTS -->
    <script>
        // --- API Configuration ---
        // API Key moved to backend

        // --- Chart Configuration Helper ---
        Chart.defaults.font.family = "'Outfit', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = '#f1f5f9';
        Chart.defaults.scale.grid.borderColor = 'transparent';

        // --- Navigation Logic ---
        function switchTab(tabId) {
            console.log("Switching to tab:", tabId);
            ['dashboard', 'spoilage', 'market', 'soil', 'rotation', 'predictions', 'disease'].forEach(id => {
                const view = document.getElementById('view-' + id);
                const tab = document.getElementById('tab-' + id);

                if (view) {
                    view.classList.add('hidden');
                }
                if (tab) {
                    tab.classList.remove('active-tab');
                    tab.classList.add('text-slate-500', 'hover:text-primary', 'hover:bg-slate-50', 'dark:text-slate-400', 'dark:hover:text-cyan-400', 'dark:hover:bg-white/5');
                }
            });

            const activeView = document.getElementById('view-' + tabId);
            const activeTab = document.getElementById('tab-' + tabId);
            const mobileMenu = document.getElementById('mobile-menu');

            if (activeView) {
                activeView.classList.remove('hidden');

                // Reset animations for re-triggering
                activeView.classList.remove('fade-in');
                const animatedElements = activeView.querySelectorAll('.slide-up');
                animatedElements.forEach(el => {
                    el.style.animation = 'none';
                    el.style.opacity = '0';
                });

                void activeView.offsetWidth; // Trigger reflow

                activeView.classList.add('fade-in');
                animatedElements.forEach(el => {
                    el.style.animation = '';
                    el.style.opacity = '';
                });
            }

            if (activeTab) {
                activeTab.classList.add('active-tab');
                activeTab.classList.remove('text-slate-500', 'hover:text-primary', 'hover:bg-slate-50', 'dark:text-slate-400', 'dark:hover:text-cyan-400', 'dark:hover:bg-white/5');
            }

            if (tabId === 'predictions') {
                setTimeout(initPredictionCharts, 50);
            }

            if (tabId === 'rotation') {
                generateRotationPlan();
            }

            if (tabId === 'market') {
                setTimeout(() => { if (mandiMiniMap) mandiMiniMap.invalidateSize(); }, 200);
                initMandiMiniMap();
            }

            if (mobileMenu) mobileMenu.classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        function enterApp() {
            const overlay = document.getElementById('login-overlay');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => overlay.remove(), 500);
        }

        // --- Location Management ---
        let userLocation = {
            lat: 28.6139, // Default: Delhi
            lng: 77.2090,
            address: 'Delhi, India',
            isAutoDetected: false
        };

        let map = null;
        let marker = null;
        let routeLayer = null;
        let destMarker = null;
        let storageChartInstance = null;

        // Request automatic geolocation
        function requestGeolocation() {
            const btn = document.querySelector('button[onclick="requestGeolocation()"]');
            const icon = btn ? btn.querySelector('i') : null;
            if (icon) icon.className = 'fa-solid fa-circle-notch fa-spin text-lg';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation.lat = position.coords.latitude;
                        userLocation.lng = position.coords.longitude;
                        userLocation.isAutoDetected = true;

                        // Update map if it exists
                        if (map) {
                            map.setView([userLocation.lat, userLocation.lng], 16);
                            if (marker) {
                                marker.setLatLng([userLocation.lat, userLocation.lng]);
                            }
                        }

                        reverseGeocode(userLocation.lat, userLocation.lng);
                        updateLocationDisplay();
                        if (icon) icon.className = 'fa-solid fa-crosshairs text-lg';
                    },
                    (error) => {
                        console.log('Geolocation denied or failed:', error);
                        alert('Unable to get your location. Please select manually on the map.');
                        if (icon) icon.className = 'fa-solid fa-crosshairs text-lg';
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser. Please select location manually.');
                if (icon) icon.className = 'fa-solid fa-crosshairs text-lg';
            }
        }

        // Reverse geocode coordinates to address using Nominatim (OpenStreetMap)
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`);
                const data = await response.json();

                if (data && data.display_name) {
                    userLocation.address = data.display_name;
                    userLocation.state = data.address.state || data.address.region || data.address.county;
                    updateLocationDisplay();
                }
            } catch (error) {
                console.error('Reverse geocoding failed:', error);
                userLocation.address = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                updateLocationDisplay();
            }
        }

        // Initialize Leaflet Map with OpenStreetMap
        function initializeMap() {
            // Create map
            map = L.map('map').setView([userLocation.lat, userLocation.lng], 12);

            // Define Layers
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            });

            // Satellite Layer
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 19
            });

            // Add Satellite by default
            satelliteLayer.addTo(map);

            // Layer control to switch between map types
            const baseMaps = {
                "Satellite": satelliteLayer,
                "Street Map": streetLayer
            };

            L.control.layers(baseMaps, null, { position: 'bottomleft' }).addTo(map);

            // Add marker
            marker = L.marker([userLocation.lat, userLocation.lng], {
                draggable: true,
                title: 'Farm Location'
            }).addTo(map);

            // Update location on marker drag
            marker.on('dragend', function (event) {
                const position = marker.getLatLng();
                userLocation.lat = position.lat;
                userLocation.lng = position.lng;
                reverseGeocode(userLocation.lat, userLocation.lng);
            });

            // Update location on map click
            map.on('click', function (event) {
                userLocation.lat = event.latlng.lat;
                userLocation.lng = event.latlng.lng;
                marker.setLatLng(event.latlng);
                reverseGeocode(userLocation.lat, userLocation.lng);
            });

            // Add search functionality using Nominatim
            const searchInput = document.getElementById('locationSearch');
            searchInput.addEventListener('keypress', async function (e) {
                if (e.key === 'Enter') {
                    const query = searchInput.value;
                    if (query.trim()) {
                        await searchLocation(query);
                    }
                }
            });
        }

        // Search for location using Nominatim (OpenStreetMap)
        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&addressdetails=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0];
                    userLocation.lat = parseFloat(result.lat);
                    userLocation.lng = parseFloat(result.lon);
                    userLocation.address = result.display_name;
                    userLocation.state = result.address.state || result.address.region || result.address.county;

                    if (map && marker) {
                        map.setView([userLocation.lat, userLocation.lng], 13);
                        marker.setLatLng([userLocation.lat, userLocation.lng]);
                    }

                    updateLocationDisplay();
                } else {
                    alert('Location not found. Please try a different search term.');
                }
            } catch (error) {
                console.error('Location search failed:', error);
                alert('Search failed. Please try again.');
            }
        }

        // Handle search button click
        function handleSearchClick() {
            const searchInput = document.getElementById('locationSearch');
            const query = searchInput.value.trim();
            if (query) {
                searchLocation(query);
            } else {
                alert('Please enter a location to search.');
            }
        }

        // Toggle location map overlay
        function toggleLocationMap() {
            const overlay = document.getElementById('locationMapOverlay');
            const isHidden = overlay.classList.contains('hidden');
            overlay.classList.toggle('hidden');

            if (isHidden) {
                // Opening map - reset route if any
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                if (destMarker) {
                    map.removeLayer(destMarker);
                    destMarker = null;
                }

                // Initialize map when shown for the first time
                if (!map) {
                    setTimeout(() => initializeMap(), 100); // Small delay for DOM rendering
                } else {
                    map.invalidateSize();
                    // Re-center map to current location using Leaflet API
                    map.setView([userLocation.lat, userLocation.lng], 12);
                    marker.setLatLng([userLocation.lat, userLocation.lng]);
                }
                updateLocationDisplay();
            }
        }

        function showRouteToFacility(lat, lng, name) {
            const overlay = document.getElementById('locationMapOverlay');
            overlay.classList.remove('hidden');

            if (!map) {
                setTimeout(() => {
                    initializeMap();
                    drawRoute(lat, lng, name);
                }, 100);
            } else {
                setTimeout(() => {
                    map.invalidateSize();
                    drawRoute(lat, lng, name);
                }, 100);
            }
        }

        async function drawRoute(lat, lng, name) {
            if (routeLayer) map.removeLayer(routeLayer);
            if (destMarker) map.removeLayer(destMarker);

            // Custom Icons
            const startIcon = L.divIcon({
                html: '<div class="bg-blue-600 w-4 h-4 rounded-full border-2 border-white shadow-lg pulse-ring"></div>',
                className: '',
                iconSize: [16, 16]
            });

            const destIcon = L.divIcon({
                html: '<div class="text-red-600 text-4xl drop-shadow-xl filter"><i class="fa-solid fa-location-dot"></i></div>',
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            // Update User Marker
            if (marker) marker.setIcon(startIcon);

            // Add Destination Marker
            destMarker = L.marker([lat, lng], { icon: destIcon }).addTo(map);

            // Fetch Route from OSRM (Open Source Routing Machine)
            try {
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${userLocation.lng},${userLocation.lat};${lng},${lat}?overview=full&geometries=geojson`);
                const data = await response.json();

                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    const route = data.routes[0];

                    // Draw Route
                    routeLayer = L.geoJSON(route.geometry, {
                        style: {
                            color: '#3b82f6', // Blue-500
                            weight: 6,
                            opacity: 0.8,
                            lineCap: 'round',
                            lineJoin: 'round'
                        }
                    }).addTo(map);

                    // Fit bounds to route
                    map.fitBounds(routeLayer.getBounds(), { padding: [100, 100] });

                    // Add rich popup
                    const durationMins = Math.round(route.duration / 60);
                    const distanceKm = (route.distance / 1000).toFixed(1);

                    destMarker.bindPopup(`
                        <div class="text-center min-w-[160px] p-1">
                            <h3 class="font-bold text-slate-900 text-sm mb-1">${name}</h3>
                            <div class="flex justify-center gap-3 text-xs text-slate-600 mb-3 font-medium bg-slate-100 p-2 rounded-lg">
                                <span><i class="fa-solid fa-car"></i> ${durationMins} min</span>
                                <span><i class="fa-solid fa-road"></i> ${distanceKm} km</span>
                            </div>
                            <a href="https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${lat},${lng}" 
                               target="_blank" 
                               class="block w-full px-3 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                               <i class="fa-solid fa-location-arrow mr-1"></i> Navigate via Google Maps
                            </a>
                        </div>
                    `).openPopup();
                } else {
                    throw new Error('No route found');
                }
            } catch (error) {
                console.error('Routing failed:', error);
                // Fallback to straight line
                const latlngs = [[userLocation.lat, userLocation.lng], [lat, lng]];
                routeLayer = L.polyline(latlngs, { color: 'blue', weight: 4, opacity: 0.5, dashArray: '10, 10' }).addTo(map);
                map.fitBounds(L.latLngBounds(latlngs), { padding: [50, 50] });

                destMarker.bindPopup(`
                    <div class="text-center min-w-[160px] p-1">
                        <h3 class="font-bold text-slate-900 text-sm mb-1">${name}</h3>
                        <div class="text-xs text-slate-500 mb-3">Straight Line Distance</div>
                        <a href="https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${lat},${lng}" 
                           target="_blank" 
                           class="block w-full px-3 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                           <i class="fa-solid fa-location-arrow mr-1"></i> Navigate via Google Maps
                        </a>
                    </div>
                `).openPopup();
            }
        }

        // Confirm location selection
        function confirmLocation() {
            updateLocationDisplay();
            fetchLocationBasedSoilData();
            fetchWeatherData();
            fetchNearbyMandis();
            toggleLocationMap();

            // Show success message
            const locationText = userLocation.address.length > 50
                ? userLocation.address.substring(0, 50) + '...'
                : userLocation.address;
            alert(`‚úÖ Location set to: ${locationText}\n\nFetching soil data for this region...`);
        }

        // Update location display in UI
        function updateLocationDisplay() {
            // Update dashboard location text
            const dashLocationText = document.getElementById('dashLocationText');
            if (dashLocationText) {
                const shortAddress = userLocation.address.split(',').slice(-2).join(',').trim();
                dashLocationText.textContent = shortAddress || userLocation.address;
            }

            // Update modal location display
            const selectedLocationText = document.getElementById('selectedLocationText');
            const selectedCoordinates = document.getElementById('selectedCoordinates');

            if (selectedLocationText) {
                selectedLocationText.textContent = userLocation.address;
            }

            if (selectedCoordinates) {
                const latDir = userLocation.lat >= 0 ? 'N' : 'S';
                const lngDir = userLocation.lng >= 0 ? 'E' : 'W';
                selectedCoordinates.textContent =
                    `${Math.abs(userLocation.lat).toFixed(4)}¬∞${latDir}, ${Math.abs(userLocation.lng).toFixed(4)}¬∞${lngDir}`;
            }
        }

        // Fetch location-based soil data using open-source SoilGrids API
        async function fetchLocationBasedSoilData() {
            try {
                // SoilGrids REST API (ISRIC World Soil Information)
                // Fetches nitrogen, pH, and SOC at 0-5cm depth
                const soilGridsUrl = `https://rest.isric.org/soilgrids/v2.0/properties/query?lon=${userLocation.lng}&lat=${userLocation.lat}&property=nitrogen&property=phh2o&property=soc&depth=0-5cm&value=mean`;

                const response = await fetch(soilGridsUrl);
                const data = await response.json();

                let soilData = {
                    nitrogen: 0,
                    ph: 0,
                    soc: 0,
                    source: 'SoilGrids (ISRIC)',
                    coordinates: `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`
                };

                if (data && data.properties && data.properties.layers) {
                    data.properties.layers.forEach(layer => {
                        if (layer.depths && layer.depths.length > 0) {
                            const val = layer.depths[0].values.mean;
                            if (layer.name === 'nitrogen') soilData.nitrogen = val; // cg/kg
                            if (layer.name === 'phh2o') soilData.ph = val; // pH * 10
                            if (layer.name === 'soc') soilData.soc = val; // dg/kg
                        }
                    });
                }

                // Update soil health section with location-based data
                updateSoilHealthDisplay(soilData);

                console.log('Location-based soil data fetched from SoilGrids:', soilData);
            } catch (error) {
                console.error('Error fetching soil data from SoilGrids:', error);

                // Fallback: Use default value
                const fallbackData = {
                    nitrogen: 142, // cg/kg
                    ph: 70, // pH 7.0
                    soc: 150, // 15 g/kg
                    source: 'Default (API unavailable)',
                    coordinates: `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`
                };

                updateSoilHealthDisplay(fallbackData);
                console.log('Using fallback soil data:', fallbackData);
            }
        }

        // Update soil health display with fetched data
        function updateSoilHealthDisplay(soilData) {
            // 1. Nitrogen (cg/kg)
            // Range: 0 - 1000 cg/kg. 
            // Conversion: 1 cg/kg = 0.01 g/kg. 
            // Display: Raw value or mapped to Low/Med/High
            const nVal = soilData.nitrogen;
            const nKgHa = Math.round(nVal * 1.5); // Approx conversion to kg/ha for display

            const dashNitrogenValue = document.getElementById('dashNitrogenValue');
            if (dashNitrogenValue) dashNitrogenValue.textContent = nKgHa;

            const soilNVal = document.getElementById('soilNVal');
            const soilNBar = document.getElementById('soilNBar');

            if (soilNVal && soilNBar) {
                let nStatus = 'Optimal';
                let nColor = 'bg-green-500';
                let nText = 'text-green-600';

                if (nVal < 100) { nStatus = 'Low'; nColor = 'bg-red-500'; nText = 'text-red-600'; }
                else if (nVal > 500) { nStatus = 'High'; nColor = 'bg-yellow-500'; nText = 'text-yellow-600'; }

                soilNVal.innerHTML = `<span class="${nText}">${nStatus} (${nKgHa} kg/ha)</span>`;
                soilNBar.className = `${nColor} h-3 rounded-full transition-all duration-1000 ease-out`;
                soilNBar.style.width = Math.min((nVal / 600) * 100, 100) + '%';
            }

            // 2. pH (pH * 10)
            const phVal = soilData.ph / 10;
            const soilPhVal = document.getElementById('soilPhVal');
            const soilPhBar = document.getElementById('soilPhBar');

            if (soilPhVal && soilPhBar) {
                let phStatus = 'Neutral';
                let phColor = 'bg-green-500';

                if (phVal < 6) { phStatus = 'Acidic'; phColor = 'bg-orange-500'; }
                else if (phVal > 7.5) { phStatus = 'Alkaline'; phColor = 'bg-blue-500'; }

                soilPhVal.innerHTML = `<span class="font-bold text-slate-700 dark:text-white">${phVal.toFixed(1)}</span> <span class="text-xs text-slate-500">(${phStatus})</span>`;
                soilPhBar.className = `${phColor} h-3 rounded-full transition-all duration-1000 ease-out`;
                soilPhBar.style.width = Math.min((phVal / 14) * 100, 100) + '%';
            }

            // 3. Organic Carbon (dg/kg) -> g/kg
            // 1 dg/kg = 0.1 g/kg
            const socVal = soilData.soc / 10; // g/kg
            const soilSocVal = document.getElementById('soilSocVal');
            const soilSocBar = document.getElementById('soilSocBar');

            if (soilSocVal && soilSocBar) {
                let socStatus = 'Good';
                let socColor = 'bg-green-500';

                if (socVal < 5) { socStatus = 'Very Low'; socColor = 'bg-red-500'; }
                else if (socVal < 10) { socStatus = 'Low'; socColor = 'bg-yellow-500'; }
                else if (socVal > 20) { socStatus = 'High'; socColor = 'bg-emerald-600'; }

                soilSocVal.innerHTML = `<span class="font-bold text-slate-700 dark:text-white">${socVal.toFixed(1)} g/kg</span> <span class="text-xs text-slate-500">(${socStatus})</span>`;
                soilSocBar.className = `${socColor} h-3 rounded-full transition-all duration-1000 ease-out`;
                soilSocBar.style.width = Math.min((socVal / 30) * 100, 100) + '%';
            }

            // Fetch and update cold storage facilities for this location
            fetchColdStorageData();
        }

        // Fetch live weather data (Temperature & Humidity)
        async function fetchWeatherData() {
            try {
                // Backend Proxy
                const response = await fetch(`/api/weather?lat=${userLocation.lat}&lng=${userLocation.lng}`);
                const data = await response.json();

                if (data && data.current) {
                    const tempInput = document.getElementById('tempInput');
                    const humidityInput = document.getElementById('humidityInput');

                    if (tempInput) {
                        tempInput.value = data.current.temperature_2m;
                        // Visual feedback
                        tempInput.classList.add('ring-2', 'ring-green-500');
                        setTimeout(() => tempInput.classList.remove('ring-2', 'ring-green-500'), 1000);
                    }
                    if (humidityInput) {
                        humidityInput.value = data.current.relative_humidity_2m;
                        humidityInput.classList.add('ring-2', 'ring-green-500');
                        setTimeout(() => humidityInput.classList.remove('ring-2', 'ring-green-500'), 1000);
                    }
                }
            } catch (error) {
                console.error('Weather fetch failed:', error);
            }
        }

        // Calculate distance between two coordinates in km (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in km
            return d.toFixed(1);
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // Fetch location-based cold storage facilities using OpenStreetMap (Nominatim)
        async function fetchColdStorageData() {
            const statusElement = document.getElementById('coldStorageGrid');
            if (statusElement) statusElement.innerHTML = '<div class="col-span-3 text-center py-8"><i class="fa-solid fa-circle-notch fa-spin text-slate-300 text-3xl"></i><p class="text-slate-500 mt-2">Finding nearby storage facilities...</p></div>';

            try {
                // Calculate bounding box for ~50km radius (0.5 deg approx 55km)
                const offset = 0.5;
                const viewbox = `${userLocation.lng - offset},${userLocation.lat + offset},${userLocation.lng + offset},${userLocation.lat - offset}`;

                // Search for "cold storage" strictly within viewbox
                let searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=cold+storage&limit=15&addressdetails=1&viewbox=${viewbox}&bounded=1`;

                let response = await fetch(searchUrl);
                let results = await response.json();

                // If fewer than 5 results, try searching for "warehouse" to supplement
                if (results.length < 5) {
                    const warehouseUrl = `https://nominatim.openstreetmap.org/search?format=json&q=warehouse&limit=15&addressdetails=1&viewbox=${viewbox}&bounded=1`;
                    const warehouseResponse = await fetch(warehouseUrl);
                    const warehouseResults = await warehouseResponse.json();

                    // Merge results, avoiding duplicates based on osm_id
                    const existingIds = new Set(results.map(r => r.osm_id));
                    for (const item of warehouseResults) {
                        if (!existingIds.has(item.osm_id)) {
                            results.push(item);
                            existingIds.add(item.osm_id);
                        }
                    }
                }

                // If still fewer than 5, try an expanded radius search (~150km)
                if (results.length < 5) {
                    const expandedOffset = 1.5; // ~160km
                    const expandedViewbox = `${userLocation.lng - expandedOffset},${userLocation.lat + expandedOffset},${userLocation.lng + expandedOffset},${userLocation.lat - expandedOffset}`;

                    const broaderUrl = `https://nominatim.openstreetmap.org/search?format=json&q=cold+storage&limit=15&addressdetails=1&viewbox=${expandedViewbox}&bounded=1`;
                    const broaderResponse = await fetch(broaderUrl);
                    const broaderResults = await broaderResponse.json();

                    const existingIds = new Set(results.map(r => r.osm_id));
                    for (const item of broaderResults) {
                        if (!existingIds.has(item.osm_id)) {
                            results.push(item);
                            existingIds.add(item.osm_id);
                        }
                    }
                }

                // Process results
                let facilities = results.map(item => {
                    return {
                        name: item.name || item.display_name.split(',')[0],
                        address: item.display_name,
                        distance: calculateDistance(userLocation.lat, userLocation.lng, parseFloat(item.lat), parseFloat(item.lon)),
                        contacts: "Contact Facility", // Placeholder as OSM often lacks phone numbers
                        source: "OpenStreetMap",
                        lat: parseFloat(item.lat),
                        lon: parseFloat(item.lon)
                    };
                }).sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance)); // Sort by distance

                // Filter out results further than 250km, but keep at least one if all are far
                const nearbyFacilities = facilities.filter(f => parseFloat(f.distance) < 250);

                if (nearbyFacilities.length > 0) {
                    facilities = nearbyFacilities;
                } else {
                    // If no facilities within 250km, keep the nearest ones (already sorted)
                    facilities = facilities.slice(0, 5);
                }

                // Determine region from first result or user location
                let region = "Nearby Region";
                if (results.length > 0 && results[0].address) {
                    region = results[0].address.city || results[0].address.state_district || results[0].address.state || "Nearby";
                } else if (userLocation.address) {
                    // Fallback to user's address parts
                    const parts = userLocation.address.split(',');
                    region = parts.length > 2 ? parts[parts.length - 3] : "Local Region";
                }

                const coldStorageData = {
                    region: region,
                    facilities: facilities
                };

                // Update cold storage display
                updateColdStorageDisplay(coldStorageData);

                console.log('Cold storage data fetched from OSM:', coldStorageData);
            } catch (error) {
                console.error('Error fetching cold storage data from OSM:', error);

                // Show empty state or error
                const emptyData = {
                    region: "Unknown Region",
                    facilities: []
                };
                updateColdStorageDisplay(emptyData);
            }
        }

        // Update cold storage display with fetched real data
        function updateColdStorageDisplay(data) {
            // Update region name
            const locationElement = document.getElementById('coldStorageLocation');
            if (locationElement) {
                locationElement.textContent = data.region;
            }

            // Update facility count
            const countElement = document.getElementById('coldStorageCount');
            if (countElement) {
                countElement.textContent = data.facilities ? data.facilities.length : 0;
            }

            // Update facilities grid
            const gridElement = document.getElementById('coldStorageGrid');
            if (gridElement) {
                if (data.facilities && data.facilities.length > 0) {
                    const colors = [
                        { bg: 'bg-blue-50 dark:bg-blue-500/10', text: 'text-blue-600 dark:text-blue-400' },
                        { bg: 'bg-green-50 dark:bg-green-500/10', text: 'text-green-600 dark:text-green-400' },
                        { bg: 'bg-purple-50 dark:bg-purple-500/10', text: 'text-purple-600 dark:text-purple-400' }
                    ];

                    gridElement.innerHTML = data.facilities.slice(0, 9).map((facility, index) => { // Show max 9
                        const color = colors[index % colors.length];
                        return `
                            <div onclick="showRouteToFacility(${facility.lat}, ${facility.lon}, '${facility.name.replace(/'/g, "\\'")}')" class="border border-slate-200 dark:border-slate-700 rounded-xl p-4 hover:shadow-md transition-shadow cursor-pointer group">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold text-slate-900 dark:text-white line-clamp-1 group-hover:text-blue-600 transition-colors" title="${facility.name}">${facility.name}</h4>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                            <i class="fa-solid fa-location-arrow text-blue-500"></i> ${facility.distance} km away
                                        </p>
                                    </div>
                                    <div class="p-2 ${color.bg} rounded-lg">
                                        <i class="fa-solid fa-warehouse ${color.text}"></i>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600 dark:text-slate-400">Rate:</span>
                                        <span class="font-semibold text-slate-900 dark:text-white">Contact for Price</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600 dark:text-slate-400">Capacity:</span>
                                        <span class="font-medium text-slate-700 dark:text-slate-300">Start Inquiry</span>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                        <p class="text-xs text-slate-500 dark:text-slate-400 text-ellipsis overflow-hidden whitespace-nowrap" title="${facility.address}">
                                            <i class="fa-solid fa-map-pin text-green-600"></i> ${facility.address}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    gridElement.innerHTML = `
                        <div class="col-span-3 text-center p-8 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                            <i class="fa-solid fa-warehouse text-4xl text-slate-300 mb-3"></i>
                            <p class="text-slate-500">No cold storage facilities found nearby.</p>
                            <p class="text-xs text-slate-400 mt-1">Try searching for a major city or district center.</p>
                        </div>
                    `;
                }
            }
        }

        // --- Mandi Mini Map Logic ---
        let mandiMiniMap = null;
        let mandiLayerGroup = null;

        function initMandiMiniMap() {
            if (mandiMiniMap) return;

            const container = document.getElementById('mandiMiniMap');
            if (!container) return;

            mandiMiniMap = L.map('mandiMiniMap', {
                zoomControl: false,
                attributionControl: false
            }).setView([userLocation.lat, userLocation.lng], 10);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(mandiMiniMap);

            mandiLayerGroup = L.layerGroup().addTo(mandiMiniMap);

            // Add user location marker
            L.circleMarker([userLocation.lat, userLocation.lng], {
                radius: 6,
                fillColor: "#3b82f6",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(mandiMiniMap);
        }

        // Focus mini map on a specific mandi
        function focusMandiOnMap(lat, lon, name) {
            if (mandiMiniMap) {
                mandiMiniMap.setView([lat, lon], 13);
                if (mandiLayerGroup) {
                    mandiLayerGroup.eachLayer(layer => {
                        const lLat = layer.getLatLng().lat;
                        const lLng = layer.getLatLng().lng;
                        if (Math.abs(lLat - lat) < 0.0001 && Math.abs(lLng - lon) < 0.0001) {
                            layer.openPopup();
                        }
                    });
                }
            }
        }

        // Fetch location-based Mandis using OpenStreetMap (Nominatim)
        async function fetchNearbyMandis() {
            const selectElement = document.getElementById('mandiRegionSelect');
            if (!selectElement) return;

            // Show loading state if empty or just starting
            if (selectElement.options.length === 0 || selectElement.value === 'Loading nearby mandis...') {
                selectElement.innerHTML = '<option disabled selected>Locating nearby mandis...</option>';
            }
            selectElement.disabled = true;

            // Init map if not already
            initMandiMiniMap();

            try {
                // Ensure we have state information
                let state = userLocation.state;
                if (!state) {
                    // Try to fetch state if missing
                    const geoUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lng}&addressdetails=1`;
                    const geoRes = await fetch(geoUrl);
                    const geoData = await geoRes.json();
                    if (geoData && geoData.address) {
                        state = geoData.address.state || geoData.address.region;
                        userLocation.state = state;
                    }
                }

                let results = [];

                // 1. Search for "mandi" within the specific state (Broad search restricted to state)
                if (state) {
                    const stateSearchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=mandi+in+${encodeURIComponent(state)}&limit=50&addressdetails=1`;
                    const stateRes = await fetch(stateSearchUrl);
                    const stateData = await stateRes.json();
                    results = stateData;
                }

                // 2. Fallback/Supplement: Local search if state search is sparse
                if (results.length < 5) {
                    const offset = 0.5; // ~50km
                    const viewbox = `${userLocation.lng - offset},${userLocation.lat + offset},${userLocation.lng + offset},${userLocation.lat - offset}`;

                    // Try "market" locally
                    const localUrl = `https://nominatim.openstreetmap.org/search?format=json&q=market&limit=20&addressdetails=1&viewbox=${viewbox}&bounded=0`;
                    const localRes = await fetch(localUrl);
                    const localData = await localRes.json();

                    const existingIds = new Set(results.map(r => r.osm_id));
                    for (const item of localData) {
                        if (!existingIds.has(item.osm_id)) {
                            results.push(item);
                            existingIds.add(item.osm_id);
                        }
                    }
                }

                // 3. Process Results: Calculate Distance & Filter
                results.forEach(r => {
                    r.distVal = parseFloat(calculateDistance(userLocation.lat, userLocation.lng, r.lat, r.lon));
                });

                // Filter: Must be in the same state (if state is known) OR very close (< 20km border areas)
                if (state) {
                    results = results.filter(r => {
                        const rState = r.address.state || r.address.region || "";
                        return rState.toLowerCase().includes(state.toLowerCase()) || r.distVal < 20;
                    });
                }

                // Sort by distance
                results.sort((a, b) => a.distVal - b.distVal);

                // Limit to nearest 20
                results = results.slice(0, 20);

                // Clear loading
                selectElement.innerHTML = '';

                // Clear Map Layers & List
                if (mandiLayerGroup) mandiLayerGroup.clearLayers();
                const listContainer = document.getElementById('mandiListContainer');
                if (listContainer) listContainer.innerHTML = '';

                let bounds = L.latLngBounds([userLocation.lat, userLocation.lng], [userLocation.lat, userLocation.lng]);

                if (results.length > 0) {
                    results.forEach((mandi, index) => {
                        let name = mandi.name || mandi.display_name.split(',')[0];
                        name = name.replace(/mandi/gi, 'Mandi').replace(/market/gi, 'Market');

                        // Add city context if name is generic
                        if (name.toLowerCase().includes('market') || name.toLowerCase().includes('mandi')) {
                            const city = mandi.address.city || mandi.address.town || mandi.address.county || mandi.address.state_district;
                            if (city && !name.includes(city)) {
                                name = `${name} (${city})`;
                            }
                        }

                        const option = document.createElement('option');
                        option.value = name;
                        option.text = `${name} (${mandi.distVal} km)`;
                        option.setAttribute('data-lat', mandi.lat);
                        option.setAttribute('data-lon', mandi.lon);
                        if (index === 0) option.selected = true;
                        selectElement.appendChild(option);

                        // Add to Map
                        if (mandiLayerGroup) {
                            const lat = parseFloat(mandi.lat);
                            const lon = parseFloat(mandi.lon);
                            L.circleMarker([lat, lon], {
                                radius: 6,
                                fillColor: "#ef4444",
                                color: "#fff",
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            }).addTo(mandiLayerGroup).bindPopup(`<b class="text-slate-900">${name}</b><br><span class="text-xs text-slate-500">${mandi.distVal} km away</span>`);
                            bounds.extend([lat, lon]);
                        }

                        // Add to List
                        if (listContainer) {
                            const item = document.createElement('div');
                            item.className = "p-3 rounded-lg bg-slate-50 hover:bg-blue-50 border border-slate-100 transition-colors cursor-pointer group dark:bg-white/5 dark:border-white/5 dark:hover:bg-white/10";
                            item.onclick = () => focusMandiOnMap(parseFloat(mandi.lat), parseFloat(mandi.lon), name);

                            item.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h5 class="font-bold text-slate-800 text-xs dark:text-white group-hover:text-blue-600 transition-colors line-clamp-1" title="${name}">${name}</h5>
                                        <p class="text-[10px] text-slate-500 dark:text-slate-400 line-clamp-1">${mandi.address.city || mandi.address.county || mandi.address.state_district || ""}</p>
                                    </div>
                                    <span class="text-[10px] font-bold text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded dark:bg-blue-900/30 dark:text-blue-400 whitespace-nowrap">${mandi.distVal} km</span>
                                </div>
                            `;
                            listContainer.appendChild(item);
                        }
                    });
                } else {
                    const city = userLocation.address.split(',')[0] || "Local";
                    const option = document.createElement('option');
                    option.value = `${city} Mandi`;
                    option.text = `${city} Mandi (Est.)`;
                    option.selected = true;
                    selectElement.appendChild(option);

                    if (listContainer) {
                        listContainer.innerHTML = '<div class="text-center py-4 text-slate-400 text-xs">No specific mandis found nearby.</div>';
                    }
                }

                // Add benchmarks
                const benchmarks = ["Azadpur (Delhi)", "Vashi (Mumbai)", "Hapur (UP)"];
                if (results.length > 0) {
                    const separator = document.createElement('option');
                    separator.disabled = true;
                    separator.text = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
                    selectElement.appendChild(separator);
                }
                benchmarks.forEach(bm => {
                    const option = document.createElement('option');
                    option.value = bm;
                    option.text = bm;
                    selectElement.appendChild(option);
                });

                selectElement.disabled = false;
                updateMarketChart();

                if (mandiMiniMap && results.length > 0) {
                    mandiMiniMap.fitBounds(bounds, { padding: [20, 20] });
                }

            } catch (error) {
                console.error('Error fetching mandis:', error);
                selectElement.innerHTML = '<option>Azadpur (Delhi)</option><option>Vashi (Mumbai)</option><option>Hapur (UP)</option>';
                selectElement.disabled = false;
                updateMarketChart();
            }
        }

        // Open map for selected mandi
        function viewMandiLocation() {
            const select = document.getElementById('mandiRegionSelect');
            const selectedOption = select.options[select.selectedIndex];

            if (selectedOption && !selectedOption.disabled) {
                const lat = selectedOption.getAttribute('data-lat');
                const lon = selectedOption.getAttribute('data-lon');

                if (lat && lon) {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`, '_blank');
                } else {
                    alert('Location coordinates not available for this mandi.');
                }
            }
        }

        // --- Spoilage Prediction Logic ---
        async function predictSpoilage(event) {
            event.preventDefault();

            // Get values
            const temp = document.getElementById('tempInput').value;
            const humidity = document.getElementById('humidityInput').value;
            const days = document.getElementById('durationInput').value;
            const cropType = document.getElementById('cropType').value.trim();

            // Validate crop type is not empty
            if (!cropType) {
                alert('Please enter a crop name before predicting spoilage risk.');
                document.getElementById('cropType').focus();
                return;
            }

            // CALL YOUR NEW BACKEND
            try {
                const response = await fetch('/api/predict-spoilage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ temp, humidity, days })
                });

                const data = await response.json();

                // Update UI with result from server
                const isHighRisk = data.isHighRisk;
                const risk = data.risk;
                const colorClass = isHighRisk ? 'text-red-600' : 'text-green-600';
                const bgClass = isHighRisk ? 'bg-red-50 dark:bg-red-500/10' : 'bg-green-50 dark:bg-emerald-500/10';
                const icon = isHighRisk ? '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-circle-check text-green-500"></i>';

                const resDiv = document.getElementById('predictionResult');
                resDiv.innerHTML = `
                    <div class="${bgClass} w-full h-full rounded-2xl flex flex-col justify-center items-center relative overflow-hidden fade-in px-4 border border-white/10">
                        <div class="absolute top-4 right-4 text-2xl">${icon}</div>
                        <p class="text-slate-500 font-medium mb-1 dark:text-slate-400">Spoilage Probability</p>
                        <h2 class="text-6xl font-extrabold ${colorClass} mb-2 tracking-tight">${risk.toFixed(1)}%</h2>
                        <p class="text-sm text-slate-500 mb-4 dark:text-slate-400">Safe Storage Window: <span class="font-bold text-slate-800 dark:text-white">${data.recommendation.includes('days') ? data.recommendation.match(/(\d+) more days/)?.[1] + ' Days' : 'Immediate Action'}</span></p>
                        
                        <div class="w-full max-w-xs bg-white/50 dark:bg-white/10 rounded-full h-2">
                            <div class="${isHighRisk ? 'bg-red-500' : 'bg-green-500'} h-2 rounded-full transition-all duration-1000" style="width: ${risk}%"></div>
                        </div>
                    </div>
                `;
                resDiv.classList.remove('border-2', 'border-dashed', 'p-12');
                resDiv.classList.add('p-0', 'border-0');

                // Show the AI recommendation card
                document.getElementById('aiRecommendation').classList.remove('hidden');
                document.getElementById('recText').innerText = data.recommendation;

                // Update Dashboard Spoilage Risk Card (Simplified for now)
                const dashRisk = document.getElementById('dashSpoilageRisk');
                if (dashRisk) {
                    dashRisk.textContent = isHighRisk ? 'High' : 'Low';
                    dashRisk.className = `text-3xl font-bold mt-2 ${isHighRisk ? 'text-red-600' : 'text-green-600'}`;
                }

            } catch (error) {
                console.error("Prediction Error:", error);
                alert("Failed to get prediction from server.");
            }
        }

        // --- Rotation Plan Logic ---
        function generateRotationPlan() {
            const container = document.getElementById('rotationPlanContainer');
            if (!container) return;

            // Show loading state
            container.innerHTML = '<div class="py-12 text-center"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-primary"></i><p class="mt-2 text-slate-500">Analyzing market trends & soil data...</p></div>';

            setTimeout(() => {
                // Define high-demand crop plans
                const plans = [
                    [
                        {
                            name: "Rice (Basmati)",
                            type: "Cereal",
                            duration: 120,
                            benefit: "High Export Demand",
                            color: "green",
                            videoId: "9bZkp7q19f0",
                            aiTip: "Basmati prices are projected to rise by 15% due to export demand. Ensure water level is maintained at 2-3cm.",
                            steps: ["Prepare nursery with organic compost.", "Transplant 25-day old seedlings.", "Apply Zinc Sulphate for better grain quality.", "Harvest when 90% grains turn golden yellow."]
                        },
                        {
                            name: "Mustard",
                            type: "Oilseed",
                            duration: 100,
                            benefit: "Low Input Cost",
                            color: "yellow",
                            videoId: "O1_Dk_zO-24",
                            aiTip: "Low moisture requirement makes it ideal for post-monsoon season. High oil content varieties fetch premium prices.",
                            steps: ["Sow seeds in rows 30cm apart.", "Thinning is crucial at 15-20 days.", "Apply Sulphur to increase oil content.", "Control aphids using Neem oil spray."]
                        },
                        {
                            name: "Moong Dal",
                            type: "Legume",
                            duration: 65,
                            benefit: "Nitrogen Fixation",
                            color: "blue",
                            videoId: "O1_Dk_zO-24",
                            aiTip: "Short duration crop that restores soil nitrogen for the next paddy cycle. Incorporate residues into soil.",
                            steps: ["Select short duration variety (PDM-139).", "Seed treatment with Rhizobium culture.", "One irrigation at flowering stage.", "Harvest pods when they turn black."]
                        }
                    ],
                    [
                        { name: "Maize", type: "Cereal", duration: 100, benefit: "High Biomass & Fodder", color: "yellow", videoId: "O1_Dk_zO-24", aiTip: "Excellent for silage. High demand in poultry industry.", steps: ["Prepare land with deep ploughing.", "Sow on ridges for better drainage.", "Apply Atrazine for weed control.", "Harvest when cob husk turns dry."] },
                        { name: "Potato", type: "Tuber", duration: 90, benefit: "Quick Cash Crop", color: "orange", videoId: "O1_Dk_zO-24", aiTip: "Cold storage availability is key. Prices peak in May-June.", steps: ["Use disease-free seed tubers.", "Earthing up at 25-30 days.", "Prevent Late Blight with fungicide.", "Dehaulm 10 days before harvest."] },
                        { name: "Sunflower", type: "Oilseed", duration: 95, benefit: "Drought Tolerant", color: "green", videoId: "O1_Dk_zO-24", aiTip: "Deep root system helps in drought. Good for intercropping.", steps: ["Seed treatment with Imidacloprid.", "Maintain spacing of 60x30 cm.", "Hand pollination increases yield.", "Harvest when back of head turns lemon yellow."] }
                    ],
                    [
                        { name: "Cotton", type: "Fiber", duration: 160, benefit: "High Industrial Demand", color: "purple", videoId: "O1_Dk_zO-24", aiTip: "Bt Cotton recommended for pest resistance. Monitor for Pink Bollworm.", steps: ["Sow in well-drained soil.", "Gap filling within 10 days.", "Foliar spray of Magnesium Sulphate.", "Pick clean dry bolls."] },
                        { name: "Wheat (HD-3226)", type: "Cereal", duration: 140, benefit: "Staple Food Security", color: "green", videoId: "O1_Dk_zO-24", aiTip: "Sow by Nov 15 for max yield. HD-3226 is resistant to rusts.", steps: ["Seed rate 40kg/acre.", "Apply CRI irrigation at 21 days.", "Top dress Urea before 2nd irrigation.", "Harvest when grain is hard."] },
                        { name: "Green Manure (Dhaincha)", type: "Cover", duration: 45, benefit: "Soil Rejuvenation", color: "blue", videoId: "O1_Dk_zO-24", aiTip: "Plough back into soil before flowering to add 40kg N/ha.", steps: ["Broadcast seeds @ 20kg/acre.", "No irrigation usually required.", "Plough in situ at 45 days.", "Allow decomposition for 10 days."] }
                    ]
                ];

                // Select a plan (simulating AI optimization)
                const selectedPlan = plans[Math.floor(Math.random() * plans.length)];

                let html = '';
                let currentDate = new Date();
                // Start planning from next month
                currentDate.setMonth(currentDate.getMonth() + 1);

                selectedPlan.forEach((crop, index) => {
                    // Calculate dates
                    const startMonth = currentDate.toLocaleString('default', { month: 'short', year: 'numeric' });

                    // Add duration
                    currentDate.setDate(currentDate.getDate() + crop.duration);
                    const endMonth = currentDate.toLocaleString('default', { month: 'short', year: 'numeric' });

                    // Add gap for soil prep (20 days)
                    currentDate.setDate(currentDate.getDate() + 20);

                    const colors = {
                        green: { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-800 dark:text-green-400', border: 'border-green-200 dark:border-green-800', dot: 'bg-green-600' },
                        yellow: { bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-800 dark:text-yellow-400', border: 'border-yellow-200 dark:border-yellow-800', dot: 'bg-yellow-500' },
                        blue: { bg: 'bg-blue-100 dark:bg-blue-900/30', text: 'text-blue-800 dark:text-blue-400', border: 'border-blue-200 dark:border-blue-800', dot: 'bg-blue-600' },
                        purple: { bg: 'bg-purple-100 dark:bg-purple-900/30', text: 'text-purple-800 dark:text-purple-400', border: 'border-purple-200 dark:border-purple-800', dot: 'bg-purple-600' },
                        orange: { bg: 'bg-orange-100 dark:bg-orange-900/30', text: 'text-orange-800 dark:text-orange-400', border: 'border-orange-200 dark:border-orange-800', dot: 'bg-orange-500' }
                    };

                    const theme = colors[crop.color] || colors.green;

                    html += `
                    <div class="relative slide-up" style="animation-delay: ${index * 0.1}s">
                        <div class="absolute -left-[41px] top-0 bg-white p-1 dark:bg-transparent">
                            <div class="w-4 h-4 ${theme.dot} rounded-full ring-4 ring-slate-100 dark:ring-slate-700"></div>
                        </div>
                        <h4 class="font-bold text-slate-900 text-lg dark:text-white">Season ${index + 1}: ${crop.name}</h4>
                        <p class="text-sm text-slate-500 mb-3 dark:text-slate-400"><i class="fa-regular fa-calendar mr-1"></i> ${startMonth} - ${endMonth} (${crop.duration} Days)</p>
                        <span class="inline-block ${theme.bg} ${theme.text} text-xs font-bold px-3 py-1 rounded-full border ${theme.border}">
                            ${crop.benefit}
                        </span>
                        
                        <!-- AI Guide Button -->
                        <button onclick="toggleStepDetails('step-details-${index}')" class="mt-4 w-full md:w-auto text-sm flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 dark:bg-white/5 dark:hover:bg-white/10 dark:text-slate-300 transition-colors border border-slate-200 dark:border-white/10 group">
                            <i class="fa-solid fa-wand-magic-sparkles text-purple-500 group-hover:rotate-12 transition-transform"></i> View AI Guide & Process
                        </button>

                        <!-- Hidden Details Section -->
                        <div id="step-details-${index}" class="hidden mt-4 bg-white dark:bg-slate-800/50 p-5 rounded-xl border border-slate-200 dark:border-white/10 shadow-sm">
                            <!-- AI Tip -->
                            <div class="mb-5 p-4 bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-xl border border-purple-100 dark:border-purple-800/30 flex gap-4">
                                <div class="bg-white dark:bg-white/10 p-2 rounded-lg h-fit shadow-sm">
                                    <i class="fa-solid fa-robot text-purple-600 dark:text-purple-400 text-xl"></i>
                                </div>
                                <div>
                                    <h5 class="font-bold text-slate-800 dark:text-white text-sm mb-1">AI Strategic Advice</h5>
                                    <p class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed">${crop.aiTip}</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Steps -->
                                <div>
                                    <h5 class="font-bold text-slate-800 dark:text-white text-sm mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-list-check text-green-500"></i> Step-by-Step Process
                                    </h5>
                                    <ul class="space-y-3">
                                        ${crop.steps.map((step, i) => `
                                            <li onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(step + ' for ' + crop.name)}', '_blank')" class="flex gap-3 text-sm text-slate-600 dark:text-slate-400 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-2 rounded-lg transition-all group/step" title="Click for detailed explanation">
                                                <span class="flex-shrink-0 w-5 h-5 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-500">${i + 1}</span>
                                                <span class="group-hover/step:text-blue-600 dark:group-hover/step:text-blue-400 transition-colors">${step} <i class="fa-solid fa-arrow-up-right-from-square text-[10px] ml-1 opacity-0 group-hover/step:opacity-100 transition-opacity"></i></span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>

                                <!-- Video -->
                                <div>
                                    <h5 class="font-bold text-slate-800 dark:text-white text-sm mb-3 flex items-center gap-2">
                                        <i class="fa-brands fa-youtube text-red-500"></i> Tutorial Video
                                    </h5>
                                    <div class="mt-3 grid grid-cols-2 gap-3">
                                        <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(crop.name + ' farming guide')}" target="_blank" class="flex items-center justify-center gap-2 px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 dark:bg-red-900/20 dark:hover:bg-red-900/30 dark:text-red-400 rounded-lg text-xs font-bold transition-colors">
                                            <i class="fa-brands fa-youtube"></i> Watch More
                                        </a>
                                        <a href="https://www.google.com/search?q=${encodeURIComponent(crop.name + ' farming guide')}" target="_blank" class="flex items-center justify-center gap-2 px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 dark:bg-blue-900/20 dark:hover:bg-blue-900/30 dark:text-blue-400 rounded-lg text-xs font-bold transition-colors">
                                            <i class="fa-solid fa-book-open"></i> Read Article
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });

                container.innerHTML = html;
            }, 600);
        }

        function toggleStepDetails(id) {
            const el = document.getElementById(id);
            if (el) {
                if (el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    el.classList.add('fade-in');
                } else {
                    el.classList.add('hidden');
                    el.classList.remove('fade-in');
                }
            }
        }

        // --- Disease Detection Logic ---

        let model = null;

        // Initialize TensorFlow Model
        async function loadModel() {
            try {
                // In a production app, load from a URL:
                // model = await tf.loadLayersModel('path/to/model.json');

                // For this demo, we create a simple model on the fly to ensure the pipeline works
                model = tf.sequential();
                model.add(tf.layers.conv2d({ inputShape: [224, 224, 3], kernelSize: 3, filters: 16, activation: 'relu' }));
                model.add(tf.layers.globalAveragePooling2d({}));
                model.add(tf.layers.dense({ units: 4, activation: 'softmax' }));

                console.log("‚úÖ AI Model loaded successfully (Simulated)");
            } catch (error) {
                console.error("‚ùå Model loading failed:", error);
            }
        }

        // Mock Database of Diseases -> Moved to Backend
        const diseaseDatabase = {};

        function previewDiseaseImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('diseaseImagePreview').src = e.target.result;
                    document.getElementById('diseaseImagePreview').classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                    document.getElementById('removeImageBtn').classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        function removeDiseaseImage(event) {
            event.stopPropagation();
            document.getElementById('diseaseImageInput').value = '';
            document.getElementById('diseaseImagePreview').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('removeImageBtn').classList.add('hidden');
        }

        async function analyzeDisease() {
            const crop = document.getElementById('diseaseCropSelect').value;
            const symptom = document.getElementById('diseaseSymptomSelect').value;
            const imageInput = document.getElementById('diseaseImageInput');
            const hasImage = imageInput.files.length > 0;

            // UI State Management
            document.getElementById('diseaseEmpty').classList.add('hidden');
            document.getElementById('diseaseResult').classList.add('hidden');
            document.getElementById('diseaseLoading').classList.remove('hidden');

            try {
                let result = null;

                // AI Prediction Pipeline
                if (hasImage && model) {
                    console.log("üöÄ Starting AI Prediction Pipeline...");
                    const imgEl = document.getElementById('diseaseImagePreview');

                    // 1. Preprocessing
                    const tensor = tf.tidy(() => {
                        // Convert DOM image to Tensor
                        let t = tf.browser.fromPixels(imgEl);
                        console.log("üì∏ Raw Image Shape:", t.shape);

                        // Resize to Model Input Shape (e.g., 224x224)
                        t = tf.image.resizeBilinear(t, [224, 224]);
                        console.log("üìè Resized Shape:", t.shape);

                        // Normalize Pixel Values (0-255 -> 0-1)
                        t = t.toFloat().div(tf.scalar(255.0));

                        // Add Batch Dimension ([224,224,3] -> [1,224,224,3])
                        t = t.expandDims(0);
                        console.log("üì¶ Batch Input Shape:", t.shape);
                        return t;
                    });

                    // 2. Prediction
                    const predictions = await model.predict(tensor).data();
                    tensor.dispose(); // Cleanup memory

                    console.log("üìä Raw Prediction Probabilities:", predictions);

                    // 3. Post-processing
                    const maxProb = Math.max(...predictions);
                    const classIndex = predictions.indexOf(maxProb);
                    console.log("üéØ Predicted Class Index:", classIndex);

                    // Map Index to Disease (Mock Mapping for Demo)
                    // In real app, this matches model.json labels
                    const classMap = [
                        { c: 'Wheat', s: 'yellowing' },
                        { c: 'Wheat', s: 'spots' },
                        { c: 'Rice', s: 'wilting' },
                        { c: 'Potato', s: 'spots' }
                    ];

                    const mapped = classMap[classIndex] || classMap[0];

                    try {
                        const response = await fetch(`/api/disease?crop=${mapped.c}&symptom=${mapped.s}`);
                        if (response.ok) {
                            result = await response.json();
                            result.confidence = (maxProb * 100).toFixed(1) + '%';
                        }
                    } catch (e) {
                        console.error("Backend fetch error:", e);
                    }
                }

                // Fallback Logic (if no image or model issue)
                if (!result) {
                    console.warn("‚ö†Ô∏è Using fallback logic (No image or model unavailable)");
                    try {
                        const response = await fetch(`/api/disease?crop=${crop}&symptom=${symptom}`);
                        if (response.ok) {
                            result = await response.json();
                        } else {
                            // Ultimate fallback
                            const fbResponse = await fetch(`/api/disease?crop=Wheat&symptom=yellowing`);
                            if (fbResponse.ok) {
                                result = await fbResponse.json();
                            }
                        }
                    } catch (e) {
                        console.error("Fallback fetch error:", e);
                    }
                }

                // Render Results
                document.getElementById('diseaseName').innerText = result.name;
                document.getElementById('diseaseConfidence').innerText = result.confidence;
                document.getElementById('diseaseCause').innerText = result.cause;
                document.getElementById('diseaseSeverity').innerText = result.severity;
                document.getElementById('diseaseImpact').innerText = result.impact;
                document.getElementById('diseaseChemical').innerText = result.chemical;
                document.getElementById('diseaseDosage').innerText = result.dosage;
                document.getElementById('diseaseInterval').innerText = result.interval;
                document.getElementById('diseasePrecaution').innerHTML = `<i class="fa-solid fa-shield-halved text-green-500 mt-0.5"></i> <span>${result.precaution}</span>`;
                document.getElementById('diseaseOrganic').innerText = result.organic;

                document.getElementById('diseaseSteps').innerHTML = result.steps.map((step, i) => `
                    <li class="flex gap-2"><span class="font-bold text-slate-400">${i + 1}.</span><span>${step}</span></li>
                `).join('');

                document.getElementById('diseaseLoading').classList.add('hidden');
                document.getElementById('diseaseResult').classList.remove('hidden');
                document.getElementById('diseaseResult').scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error("‚ùå Prediction Error:", error);
                document.getElementById('diseaseLoading').classList.add('hidden');
                alert("Error analyzing image. Please try again.");
            }
        }

        function findNearbyVendors() {
            const query = "pesticide shop near me";
            if (userLocation.lat && userLocation.lng) {
                window.open(`https://www.google.com/maps/search/${query}/@${userLocation.lat},${userLocation.lng},13z`, '_blank');
            } else {
                window.open(`https://www.google.com/maps/search/${query}`, '_blank');
            }
        }

        function buyOnline() {
            const chemical = document.getElementById('diseaseChemical').innerText;
            const query = encodeURIComponent(chemical + " fungicide");
            window.open(`https://www.amazon.in/s?k=${query}`, '_blank');
        }

        // --- Market Chart Logic ---
        let marketChartInstance = null;
        let dashboardMarketChartInstance = null;

        // Extensive Crop List
        const allCrops = [
            "Wheat", "Rice", "Maize", "Barley", "Sorghum", "Millet", "Oats", "Rye", "Triticale", "Quinoa",
            "Chickpea", "Pigeon pea", "Lentil", "Field pea", "Cowpea", "Black gram", "Green gram", "Kidney bean", "Soybean",
            "Groundnut", "Mustard", "Rapeseed", "Sesame", "Sunflower", "Safflower", "Linseed", "Castor",
            "Potato", "Onion", "Tomato", "Brinjal", "Cabbage", "Cauliflower", "Okra", "Carrot", "Radish",
            "Spinach", "Lettuce", "Pumpkin", "Bottle gourd", "Bitter gourd", "Cucumber", "Watermelon", "Muskmelon",
            "Peas", "Beans", "Chili", "Capsicum", "Garlic", "Ginger", "Turmeric", "Coriander", "Cumin",
            "Mango", "Banana", "Orange", "Lemon", "Lime", "Apple", "Grape", "Guava", "Papaya", "Pineapple",
            "Pomegranate", "Sapota", "Jackfruit", "Litchi", "Strawberry", "Pear", "Peach", "Plum", "Apricot",
            "Sugarcane", "Cotton", "Jute", "Tobacco", "Tea", "Coffee", "Rubber", "Cocoa", "Arecanut",
            "Black pepper", "Cardamom", "Clove", "Cinnamon", "Nutmeg", "Vanilla", "Saffron", "Asafoetida",
            "Almond", "Cashew", "Walnut", "Pistachio", "Date", "Fig", "Coconut", "Bamboo", "Aloe Vera",
            "Tulsi", "Mint", "Lemongrass", "Rose", "Jasmine", "Marigold", "Gerbera", "Gladiolus", "Orchid",
            "Mushroom", "Betel leaf", "Curry leaf", "Drumstick", "Sweet potato", "Tapioca", "Yam", "Colocasia",
            "Amaranth", "Fenugreek", "Fennel", "Ajwain", "Dill", "Celery", "Parsley", "Leek", "Broccoli",
            "Zucchini", "Asparagus", "Artichoke", "Brussels sprout", "Kale", "Swiss chard", "Turnip", "Beetroot",
            "Radish", "Carrot", "Sweet corn", "Baby corn", "Popcorn", "Finger millet", "Pearl millet", "Foxtail millet",
            "Kodo millet", "Little millet", "Barnyard millet", "Proso millet", "Buckwheat", "Amaranth grain"
        ].sort();

        // Market Data moved to backend
        const marketData = {};

        // Validate crop name against known crops list
        function validateCrop(cropName) {
            if (!cropName || cropName.trim() === '') {
                return { valid: false, normalizedName: null };
            }

            const trimmedCrop = cropName.trim();
            // Case-insensitive search in allCrops array
            const foundCrop = allCrops.find(crop => crop.toLowerCase() === trimmedCrop.toLowerCase());

            if (foundCrop) {
                return { valid: true, normalizedName: foundCrop };
            }

            return { valid: false, normalizedName: null };
        }


        async function fetchMarketData(crop, region) {
            try {
                const response = await fetch(`/api/market?crop=${encodeURIComponent(crop)}&region=${encodeURIComponent(region)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error fetching market data:", error);
                return null;
            }
        }

        async function updateMarketChart() {
            const cropInput = document.getElementById('marketCropSelect').value;

            // Validate crop name
            const validation = validateCrop(cropInput);

            if (!validation.valid) {
                // Show error message for invalid crop
                const ctx = document.getElementById('marketMainChart').getContext('2d');

                if (marketChartInstance) {
                    marketChartInstance.destroy();
                }

                // Clear price displays
                document.getElementById('currentPriceDisplay').innerText = '---';
                document.getElementById('peakPriceDisplay').innerText = '---';

                // Update dashboard elements
                const dashTitle = document.getElementById('dashMarketTitle');
                const dashPrice = document.getElementById('dashMarketPrice');
                const dashChartTitle = document.getElementById('dashMarketChartTitle');

                if (dashTitle) dashTitle.innerText = 'Market Price';
                if (dashPrice) dashPrice.innerText = '---';
                if (dashChartTitle) dashChartTitle.innerText = 'Price Forecast';

                // Display error message in chart area
                alert(`‚ùå No data available for "${cropInput}".\n\nPlease select a valid crop from the list.\n\nExamples: Wheat, Rice, Tomato, Onion, Potato, etc.`);

                // Focus back on input
                document.getElementById('marketCropSelect').focus();
                return;
            }

            // Use normalized crop name
            const crop = validation.normalizedName;
            document.getElementById('marketCropSelect').value = crop; // Update input with proper case

            // Get selected region
            const region = document.getElementById('mandiRegionSelect').value;

            // Access region-specific data
            let data = marketData[crop] ? marketData[crop][region] : null;

            // Fallback for crops not in static database
            if (!data) {
                const btn = document.querySelector('button[onclick="updateMarketChart()"]');
                const originalText = btn ? btn.innerText : 'Refresh Forecast';
                if (btn) { btn.innerText = 'AI Fetching...'; btn.disabled = true; }

                data = await fetchMarketData(crop, region);

                // Cache the data in nested structure
                if (data) {
                    if (!marketData[crop]) {
                        marketData[crop] = {};
                    }
                    marketData[crop][region] = data;
                }

                if (btn) { btn.innerText = originalText; btn.disabled = false; }

                if (!data) {
                    // Fallback if API fails - deterministic based on crop name and region
                    const basePrice = 1000 + (crop.length * 150);
                    // Add regional variation: Mumbai +6%, UP -3%, Delhi baseline
                    const regionMultiplier = region.includes('Mumbai') ? 1.06 : region.includes('UP') ? 0.97 : 1.0;
                    const adjustedBase = Math.floor(basePrice * regionMultiplier);
                    const trend = Array.from({ length: 7 }, (_, i) => Math.floor(adjustedBase + (i * 20)));
                    data = {
                        current: trend[6],
                        peak: Math.floor(Math.max(...trend) + 100),
                        trend: trend
                    };
                    // Cache the generated data
                    if (!marketData[crop]) {
                        marketData[crop] = {};
                    }
                    marketData[crop][region] = data;
                }
            }

            // Update Text
            document.getElementById('currentPriceDisplay').innerText = `‚Çπ${data.current.toLocaleString()}`;
            document.getElementById('peakPriceDisplay').innerText = `‚Çπ${data.peak.toLocaleString()}`;

            // Update Dashboard Elements
            const dashTitle = document.getElementById('dashMarketTitle');
            const dashPrice = document.getElementById('dashMarketPrice');
            const dashChartTitle = document.getElementById('dashMarketChartTitle');

            if (dashTitle) dashTitle.innerText = `Market Price (${crop})`;
            if (dashPrice) dashPrice.innerText = `‚Çπ${data.current.toLocaleString()}`;
            if (dashChartTitle) dashChartTitle.innerText = `${crop} Price Forecast`;

            // Update Chart
            const ctx = document.getElementById('marketMainChart').getContext('2d');

            if (marketChartInstance) {
                marketChartInstance.destroy();
            }

            // Create Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(43, 108, 176, 0.2)');
            gradient.addColorStop(1, 'rgba(43, 108, 176, 0)');

            const labels = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() + (i * 5));
                labels.push(d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }));
            }

            marketChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Forecasted Price: ${crop} (‚Çπ/q)`,
                        data: data.trend,
                        borderColor: '#2B6CB0',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: (val) => '‚Çπ' + val },
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Update Dashboard Chart if initialized
            if (dashboardMarketChartInstance) {
                dashboardMarketChartInstance.data.datasets[0].label = `${crop} Price`;
                dashboardMarketChartInstance.data.datasets[0].data = data.trend.slice(0, 4);
                dashboardMarketChartInstance.update();
            }
        }

        // --- Prediction Chart Logic ---
        let predictionChartInstance = null;
        function initPredictionCharts() {
            const ctx = document.getElementById('predictionChart');
            if (!ctx) return;

            if (predictionChartInstance) {
                predictionChartInstance.destroy();
            }

            const context = ctx.getContext('2d');
            const gradient = context.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); // Emerald
            gradient.addColorStop(1, 'rgba(16, 185, 129, 0.1)');

            predictionChartInstance = new Chart(context, {
                type: 'bar',
                data: {
                    labels: ['Wheat', 'Mustard', 'Chickpea', 'Barley', 'Lentil'],
                    datasets: [{
                        label: 'Projected Profit (‚Çπ/Acre)',
                        data: [24500, 21200, 18800, 16500, 15200],
                        backgroundColor: gradient,
                        borderColor: '#10B981',
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(200,200,200,0.1)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function () {
            // Populate Crop Datalists
            const cropOptions = document.getElementById('cropOptions');
            const marketCropOptions = document.getElementById('marketCropOptions');

            allCrops.forEach(crop => {
                const option = document.createElement('option');
                option.value = crop;
                cropOptions.appendChild(option.cloneNode(true));
                marketCropOptions.appendChild(option);
            });

            // Init Dashboard Charts
            const ctxStorage = document.getElementById('storageChart').getContext('2d');

            // Theme-aware colors
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#f1f5f9';
            const textColor = isDark ? '#94a3b8' : '#64748b';
            const pointBg = isDark ? '#1e293b' : '#ffffff';

            // Gradients
            const gradTemp = ctxStorage.createLinearGradient(0, 0, 0, 300);
            gradTemp.addColorStop(0, 'rgba(239, 68, 68, 0.5)'); // Red-500
            gradTemp.addColorStop(1, 'rgba(239, 68, 68, 0)');

            const gradHum = ctxStorage.createLinearGradient(0, 0, 0, 300);
            gradHum.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); // Emerald-500
            gradHum.addColorStop(1, 'rgba(16, 185, 129, 0)');

            storageChartInstance = new Chart(ctxStorage, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: [24, 25, 25, 26, 28, 27, 26],
                        borderColor: '#ef4444', // Red-500
                        backgroundColor: gradTemp,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: pointBg,
                        pointBorderColor: '#ef4444',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#ef4444'
                    }, {
                        label: 'Humidity (%)',
                        data: [55, 58, 60, 62, 65, 63, 60],
                        borderColor: '#10b981', // Emerald-500
                        backgroundColor: gradHum,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: pointBg,
                        pointBorderColor: '#10b981',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 8,
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        },
                        y: {
                            grid: { borderDash: [4, 4], color: gridColor },
                            ticks: { color: textColor }
                        }
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });

            const ctxMarketDash = document.getElementById('marketChartDashboard').getContext('2d');

            const gradMarket = ctxMarketDash.createLinearGradient(0, 0, 0, 300);
            gradMarket.addColorStop(0, 'rgba(214, 158, 46, 0.2)');
            gradMarket.addColorStop(1, 'rgba(214, 158, 46, 0)');

            dashboardMarketChartInstance = new Chart(ctxMarketDash, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Wheat Price',
                        data: marketData['Wheat']['Azadpur (Delhi)'].trend.slice(0, 4),
                        borderColor: '#D69E2E', // Yellow
                        backgroundColor: gradMarket,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { display: false } }
                }
            });

            // Init Market Module Chart
            // updateMarketChart(); // Called by fetchNearbyMandis

            // Fetch initial data for default location
            fetchLocationBasedSoilData();
            fetchWeatherData();
            fetchNearbyMandis();
            loadModel(); // Load AI Model
        });

        function updateChartsTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#f1f5f9';
            const textColor = isDark ? '#94a3b8' : '#64748b';
            const pointBg = isDark ? '#1e293b' : '#ffffff';

            const charts = [storageChartInstance, marketChartInstance, dashboardMarketChartInstance, predictionChartInstance];

            charts.forEach(chart => {
                if (chart) {
                    // Update scales
                    if (chart.options.scales.x) {
                        chart.options.scales.x.ticks.color = textColor;
                        if (chart.options.scales.x.grid) chart.options.scales.x.grid.color = gridColor;
                    }
                    if (chart.options.scales.y) {
                        chart.options.scales.y.ticks.color = textColor;
                        if (chart.options.scales.y.grid) chart.options.scales.y.grid.color = gridColor;
                    }

                    // Update legend
                    if (chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }

                    // Update datasets (points)
                    if (chart.data && chart.data.datasets) {
                        chart.data.datasets.forEach(dataset => {
                            dataset.pointBackgroundColor = pointBg;
                        });
                    }

                    chart.update();
                }
            });
        }

        function toggleTheme(event) {
            // Check if View Transitions API is supported
            if (!document.startViewTransition) {
                performToggle();
                return;
            }

            const x = event ? event.clientX : window.innerWidth / 2;
            const y = event ? event.clientY : window.innerHeight / 2;

            const endRadius = Math.hypot(
                Math.max(x, window.innerWidth - x),
                Math.max(y, window.innerHeight - y)
            );

            const transition = document.startViewTransition(() => {
                performToggle();
            });

            transition.ready.then(() => {
                const clipPath = [
                    `circle(0px at ${x}px ${y}px)`,
                    `circle(${endRadius}px at ${x}px ${y}px)`,
                ];
                document.documentElement.animate(
                    {
                        clipPath: clipPath,
                    },
                    {
                        duration: 500,
                        easing: 'ease-in',
                        pseudoElement: '::view-transition-new(root)',
                    }
                );
            });
        }

        function performToggle() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            }

            // Update Charts
            updateChartsTheme();
        }
    </script>

    <!-- Location Map Overlay Modal -->
    <div id="locationMapOverlay"
        class="hidden fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 transition-all duration-300">
        <div
            class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-5xl h-[85vh] relative overflow-hidden flex flex-col">

            <!-- Map Container (Full Space) -->
            <div id="map" class="absolute inset-0 z-0 bg-slate-100 dark:bg-slate-800"></div>

            <!-- Top Bar: Search & Close -->
            <div class="absolute top-0 left-0 right-0 z-10 p-4 flex gap-3 pointer-events-none">
                <!-- Search Box (Floating) -->
                <div class="flex-1 max-w-md pointer-events-auto shadow-xl rounded-2xl overflow-hidden">
                    <div class="relative">
                        <input id="locationSearch" type="text" placeholder="Search city, area or landmark..."
                            class="w-full pl-12 pr-12 py-3.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md border-0 text-slate-900 dark:text-white placeholder-slate-500 focus:ring-0 text-sm font-medium shadow-sm">
                        <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <button onclick="handleSearchClick()"
                            class="absolute right-2 top-1/2 -translate-y-1/2 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors text-slate-500">
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Close Button -->
                <button onclick="toggleLocationMap()"
                    class="ml-auto pointer-events-auto bg-white/90 dark:bg-slate-800/90 backdrop-blur-md p-3.5 rounded-2xl shadow-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition-all text-slate-600 dark:text-slate-300 group">
                    <i class="fa-solid fa-xmark text-xl group-hover:rotate-90 transition-transform"></i>
                </button>
            </div>

            <!-- Right Side Controls (My Location) -->
            <div class="absolute bottom-32 right-4 z-10 flex flex-col gap-3 pointer-events-none">
                <button onclick="requestGeolocation()"
                    class="pointer-events-auto w-12 h-12 bg-white dark:bg-slate-800 rounded-full shadow-xl flex items-center justify-center text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-700 transition-all transform hover:scale-110"
                    title="Use My Location">
                    <i class="fa-solid fa-crosshairs text-lg"></i>
                </button>
            </div>

            <!-- Bottom Panel: Info & Confirm -->
            <div class="absolute bottom-0 left-0 right-0 z-20 p-4 pointer-events-none">
                <div
                    class="pointer-events-auto bg-white dark:bg-slate-900 rounded-2xl shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.2)] p-5 flex flex-col md:flex-row items-center gap-5 border border-slate-100 dark:border-slate-800">

                    <!-- Location Info -->
                    <div class="flex-1 w-full flex items-start gap-4">
                        <div
                            class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center shrink-0">
                            <i class="fa-solid fa-location-dot text-green-600 dark:text-green-400 text-lg"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-0.5">Selected
                                Location</p>
                            <h3 id="selectedLocationText"
                                class="font-bold text-slate-900 dark:text-white text-lg leading-tight line-clamp-1">
                                Delhi, India</h3>
                            <p id="selectedCoordinates" class="text-xs text-slate-500 font-mono mt-1">28.6139¬∞N,
                                77.2090¬∞E</p>
                        </div>
                    </div>

                    <!-- Confirm Button -->
                    <button onclick="confirmLocation()"
                        class="w-full md:w-auto px-8 py-3.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-green-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2 whitespace-nowrap">
                        <span>Confirm Location</span>
                        <i class="fa-solid fa-check"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
