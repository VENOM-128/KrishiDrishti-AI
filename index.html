<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KrishiDrishti AI | Intelligent Agriculture</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2F855A', // Green-700
                        secondary: '#2B6CB0', // Blue-700
                        accent: '#D69E2E', // Yellow-600
                        danger: '#C53030', // Red-700
                    }
                }
            }
        }
    </script>
    <script>
        // Theme Initialization
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet.js for OpenStreetMap (Free, No API Key Required) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .active-tab {
            border-bottom: 3px solid #2F855A;
            color: #2F855A;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .card-interactive {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-interactive:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), 0 0 15px rgba(34, 211, 238, 0.1);
            border-color: #2F855A;
        }

        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }
    </style>
</head>

<body
    class="bg-gray-50 text-gray-800 font-sans dark:bg-slate-950 dark:bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] dark:from-slate-900 dark:via-[#050505] dark:to-black dark:text-gray-100 transition-colors duration-300">

    <!-- Login Overlay -->
    <div id="login-overlay"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-black transition-opacity duration-500">
        <div
            class="bg-white/10 backdrop-blur-xl p-8 rounded-2xl border border-white/10 shadow-2xl w-full max-w-md text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-b from-cyan-500/10 to-transparent opacity-20"></div>
            <div class="relative z-10">
                <div
                    class="mb-8 inline-block p-4 rounded-full bg-cyan-500/10 border border-cyan-500/20 shadow-[0_0_30px_rgba(34,211,238,0.2)]">
                    <i class="fa-solid fa-leaf text-cyan-400 text-4xl animate-pulse"></i>
                </div>
                <h1 class="text-4xl font-bold text-white tracking-tight mb-2">KrishiDrishti <span
                        class="text-cyan-400">AI</span></h1>
                <p class="text-slate-400 mb-8 font-light">Intelligent Agriculture Dashboard</p>
                <button onclick="enterApp()"
                    class="group w-full bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 border border-cyan-500/50 py-3.5 rounded-xl font-semibold transition-all duration-300 hover:scale-[1.02] hover:shadow-[0_0_20px_rgba(34,211,238,0.3)] flex items-center justify-center gap-2">
                    <span>ENTER SYSTEM</span>
                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav
        class="bg-white/80 backdrop-blur-md shadow-sm border-b border-slate-200 sticky top-0 z-50 dark:bg-slate-900/50 dark:border-white/5 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="bg-green-100 dark:bg-cyan-500/10 p-2 rounded-lg mr-3">
                        <i class="fa-solid fa-leaf text-primary dark:text-cyan-400 text-xl"></i>
                    </div>
                    <span class="font-bold text-xl text-slate-900 tracking-tight dark:text-white">KrishiDrishti <span
                            class="text-primary dark:text-cyan-400">AI</span></span>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Desktop Menu -->
                    <div class="hidden md:flex space-x-8">
                        <button onclick="switchTab('dashboard')" id="tab-dashboard"
                            class="active-tab px-3 py-5 text-sm font-medium transition-colors dark:text-slate-300 dark:hover:text-cyan-400">Dashboard</button>
                        <button onclick="switchTab('spoilage')" id="tab-spoilage"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-colors dark:text-slate-400 dark:hover:text-cyan-400">Spoilage
                            Risk</button>
                        <button onclick="switchTab('market')" id="tab-market"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-colors dark:text-slate-400 dark:hover:text-cyan-400">Market
                            Intel</button>
                        <button onclick="switchTab('soil')" id="tab-soil"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-colors dark:text-slate-400 dark:hover:text-cyan-400">Soil
                            Health</button>
                        <button onclick="switchTab('rotation')" id="tab-rotation"
                            class="px-3 py-5 text-sm font-medium text-gray-500 hover:text-primary transition-colors dark:text-slate-400 dark:hover:text-cyan-400">Rotation
                            Plan</button>
                    </div>

                    <!-- Theme Toggle -->
                    <button onclick="toggleTheme(event)"
                        class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-cyan-400 dark:hover:bg-white/5 transition-colors focus:outline-none">
                        <i class="fa-solid fa-moon dark:hidden"></i>
                        <i class="fa-solid fa-sun hidden dark:block"></i>
                    </button>

                    <!-- Mobile Menu Button -->
                    <div class="flex items-center md:hidden">
                        <button onclick="toggleMobileMenu()"
                            class="text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
                            <i class="fa-solid fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu"
            class="hidden md:hidden bg-white border-t px-4 py-2 shadow-lg dark:bg-slate-800 dark:border-slate-700">
            <button onclick="switchTab('dashboard')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Dashboard</button>
            <button onclick="switchTab('spoilage')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Spoilage Risk</button>
            <button onclick="switchTab('market')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Market
                Intel</button>
            <button onclick="switchTab('soil')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Soil
                Health</button>
            <button onclick="switchTab('rotation')"
                class="block w-full text-left py-2 font-medium text-gray-700 dark:text-gray-300">Rotation
                Plan</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- DASHBOARD SECTION -->
        <section id="view-dashboard" class="fade-in">
            <div class="mb-8 flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Farm Overview</h1>
                    <p class="text-slate-500 mt-1 dark:text-slate-400">Real-time insights for your 12-acre Wheat farm.
                    </p>
                    <div class="flex items-center gap-2 mt-2 text-sm text-slate-600 dark:text-slate-400">
                        <i class="fa-solid fa-location-dot text-green-600 dark:text-green-400"></i>
                        <span id="dashLocationText">Delhi, India</span>
                        <button onclick="toggleLocationMap()"
                            class="text-blue-600 hover:underline dark:text-blue-400 font-medium">
                            Change
                        </button>
                    </div>
                </div>
                <button onclick="toggleLocationMap()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 shadow-md dark:bg-green-500 dark:hover:bg-green-600">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <span>Set Location</span>
                </button>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Stat 1 -->
                <div onclick="switchTab('soil')"
                    class="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 card-interactive cursor-pointer dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-500 text-sm font-medium dark:text-slate-400">Avg. Soil Nitrogen</p>
                            <h3 class="text-3xl font-bold mt-2 text-slate-900 dark:text-white">
                                <span id="dashNitrogenValue">142</span> <span
                                    class="text-sm font-normal text-slate-400">kg/ha</span>
                            </h3>
                        </div>
                        <div
                            class="p-3 rounded-xl bg-green-50 text-green-600 dark:bg-emerald-500/10 dark:text-emerald-400">
                            <i class="fa-solid fa-seedling"></i>
                        </div>
                    </div>
                    <div class="flex items-center text-sm text-green-600 font-medium">
                        <i class="fa-solid fa-arrow-trend-up mr-1"></i> +12% <span
                            class="text-slate-400 font-normal ml-2">vs last season</span>
                    </div>
                </div>

                <!-- Stat 2 -->
                <div onclick="switchTab('spoilage')"
                    class="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 card-interactive cursor-pointer dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-500 text-sm font-medium dark:text-slate-400">Spoilage Risk</p>
                            <h3 id="dashSpoilageRisk"
                                class="text-3xl font-bold mt-2 text-slate-400 dark:text-slate-500">Not Predicted</h3>
                        </div>
                        <div id="dashSpoilageIcon"
                            class="p-3 rounded-xl bg-slate-50 text-slate-400 dark:bg-slate-500/10 dark:text-slate-500">
                            <i class="fa-solid fa-question"></i>
                        </div>
                    </div>
                    <div id="dashSpoilageDetail" class="flex items-center text-sm text-slate-500 font-medium">
                        <i class="fa-solid fa-info-circle mr-1"></i> Run prediction to see risk <span
                            class="text-slate-400 font-normal ml-2">Spoilage tab</span>
                    </div>
                </div>

                <!-- Stat 3 -->
                <div onclick="switchTab('market')"
                    class="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 card-interactive cursor-pointer dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p id="dashMarketTitle" class="text-slate-500 text-sm font-medium dark:text-slate-400">
                                Market Price (Wheat)</p>
                            <h3 class="text-3xl font-bold mt-2 text-slate-900 dark:text-white"><span
                                    id="dashMarketPrice">‚Çπ2,150</span> <span
                                    class="text-sm font-normal text-slate-400">/q</span></h3>
                        </div>
                        <div
                            class="p-3 rounded-xl bg-yellow-50 text-yellow-600 dark:bg-purple-500/10 dark:text-purple-400">
                            <i class="fa-solid fa-indian-rupee-sign"></i>
                        </div>
                    </div>
                    <div class="flex items-center text-sm text-green-600 font-medium">
                        <i class="fa-solid fa-arrow-trend-up mr-1"></i> +5.4% <span
                            class="text-slate-400 font-normal ml-2">vs last week</span>
                    </div>
                </div>

                <!-- Stat 4 -->
                <div onclick="switchTab('soil')"
                    class="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 card-interactive cursor-pointer dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-slate-500 text-sm font-medium dark:text-slate-400">Next Harvest</p>
                            <h3 class="text-3xl font-bold mt-2 text-slate-900 dark:text-white">14 Days</h3>
                        </div>
                        <div class="p-3 rounded-xl bg-blue-50 text-blue-600 dark:bg-cyan-500/10 dark:text-cyan-400">
                            <i class="fa-regular fa-calendar"></i>
                        </div>
                    </div>
                    <div class="flex items-center text-sm text-blue-600 font-medium">
                        <i class="fa-solid fa-check mr-1"></i> On Schedule
                    </div>
                </div>
            </div>

            <!-- Local Cold Storage Facilities -->
            <div
                class="mb-8 bg-white p-6 rounded-2xl shadow-soft border border-slate-100 dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg dark:text-white">üè≠ Nearby Cold Storage Facilities
                        </h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                            <i class="fa-solid fa-location-dot text-green-600 dark:text-green-400"></i>
                            <span id="coldStorageLocation">Delhi Region</span>
                        </p>
                    </div>
                    <span
                        class="text-xs font-semibold px-3 py-1 bg-blue-100 rounded-full text-blue-600 dark:bg-blue-500/10 dark:text-blue-400">
                        <span id="coldStorageCount">3</span> Facilities
                    </span>
                </div>

                <!-- Cold Storage Cards Grid -->
                <div id="coldStorageGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Facility 1 -->
                    <div
                        class="border border-slate-200 dark:border-slate-700 rounded-xl p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-slate-900 dark:text-white">Azadpur Cold Storage</h4>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                    <i class="fa-solid fa-location-arrow text-blue-500"></i> 2.5 km away
                                </p>
                            </div>
                            <div class="p-2 bg-blue-50 dark:bg-blue-500/10 rounded-lg">
                                <i class="fa-solid fa-warehouse text-blue-600 dark:text-blue-400"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600 dark:text-slate-400">Weekly Rate:</span>
                                <span class="font-semibold text-slate-900 dark:text-white">‚Çπ45/quintal</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600 dark:text-slate-400">Capacity:</span>
                                <span class="font-medium text-slate-700 dark:text-slate-300">5000 MT</span>
                            </div>
                            <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                <p class="text-xs text-slate-500 dark:text-slate-400">
                                    <i class="fa-solid fa-phone text-green-600"></i> +91-11-2765-4321
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Facility 2 -->
                    <div
                        class="border border-slate-200 dark:border-slate-700 rounded-xl p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-slate-900 dark:text-white">Mother Dairy Cold Chain</h4>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                    <i class="fa-solid fa-location-arrow text-blue-500"></i> 4.8 km away
                                </p>
                            </div>
                            <div class="p-2 bg-green-50 dark:bg-green-500/10 rounded-lg">
                                <i class="fa-solid fa-warehouse text-green-600 dark:text-green-400"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600 dark:text-slate-400">Weekly Rate:</span>
                                <span class="font-semibold text-slate-900 dark:text-white">‚Çπ50/quintal</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600 dark:text-slate-400">Capacity:</span>
                                <span class="font-medium text-slate-700 dark:text-slate-300">8000 MT</span>
                            </div>
                            <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                <p class="text-xs text-slate-500 dark:text-slate-400">
                                    <i class="fa-solid fa-phone text-green-600"></i> +91-11-2876-5432
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Facility 3 -->
                    <div
                        class="border border-slate-200 dark:border-slate-700 rounded-xl p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-slate-900 dark:text-white">NCUI Cold Storage</h4>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                    <i class="fa-solid fa-location-arrow text-blue-500"></i> 6.2 km away
                                </p>
                            </div>
                            <div class="p-2 bg-purple-50 dark:bg-purple-500/10 rounded-lg">
                                <i class="fa-solid fa-warehouse text-purple-600 dark:text-purple-400"></i>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600 dark:text-slate-400">Weekly Rate:</span>
                                <span class="font-semibold text-slate-900 dark:text-white">‚Çπ42/quintal</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-slate-600 dark:text-slate-400">Capacity:</span>
                                <span class="font-medium text-slate-700 dark:text-slate-300">6000 MT</span>
                            </div>
                            <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                <p class="text-xs text-slate-500 dark:text-slate-400">
                                    <i class="fa-solid fa-phone text-green-600"></i> +91-11-2987-6543
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Spoilage Heatmap / Chart -->
                <div
                    class="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-slate-800 text-lg dark:text-white">Storage Conditions History</h3>
                        <span
                            class="text-xs font-semibold px-3 py-1 bg-slate-100 rounded-full text-slate-600 dark:bg-white/5 dark:text-slate-300">Last
                            7
                            Days</span>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="storageChart"></canvas>
                    </div>
                </div>

                <!-- Market Price Forecast -->
                <div
                    class="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="dashMarketChartTitle" class="font-bold text-slate-800 text-lg dark:text-white">Wheat
                            Price Forecast</h3>
                        <span
                            class="text-xs font-semibold px-3 py-1 bg-green-100 text-green-800 rounded-full dark:bg-emerald-500/10 dark:text-emerald-400">Bullish
                            Trend</span>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="marketChartDashboard"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SPOILAGE PREDICTION SECTION -->
        <section id="view-spoilage" class="hidden fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Spoilage Risk Prediction</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">Analyze storage conditions to prevent crop loss using
                    AI.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Input Form -->
                <div
                    class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-soft border border-slate-100 h-fit dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10 card-interactive">
                    <h2
                        class="font-semibold text-lg mb-6 text-slate-800 border-b border-slate-100 pb-4 dark:text-white dark:border-white/5">
                        Input Parameters</h2>
                    <form onsubmit="predictSpoilage(event)" class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Crop
                                Type</label>
                            <input list="cropOptions" id="cropType" placeholder="Search or select crop..."
                                class="w-full rounded-lg border-slate-200 border p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none bg-slate-50 transition-all dark:bg-black/40 dark:border-white/10 dark:text-white dark:focus:ring-cyan-500/50 dark:focus:border-cyan-500"
                                required>
                            <datalist id="cropOptions"></datalist>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Temp
                                    (¬∞C)</label>
                                <input type="number" id="tempInput" value="28" min="-10" max="60" step="0.1"
                                    class="w-full rounded-lg border-slate-200 border p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                                    required title="Temperature must be between -10¬∞C and 60¬∞C">
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Humidity
                                    (%)</label>
                                <input type="number" id="humidityInput" value="65" min="0" max="100" step="1"
                                    class="w-full rounded-lg border-slate-200 border p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                                    required title="Humidity must be between 0% and 100%">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Storage
                                Duration (Days)</label>
                            <input type="number" id="durationInput" value="15" min="1" max="365" step="1"
                                class="w-full rounded-lg border-slate-200 border p-3 focus:ring-2 focus:ring-primary/20 focus:border-primary focus:outline-none transition-all dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                                required title="Storage duration must be between 1 and 365 days">
                        </div>

                        <button type="submit"
                            class="w-full bg-primary text-white py-3 rounded-lg hover:bg-green-700 transition-all transform hover:scale-[1.02] active:scale-[0.98] font-medium shadow-lg shadow-green-700/20">
                            Predict Risk
                        </button>
                    </form>
                </div>

                <!-- Results Panel -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Score Card -->
                    <div id="predictionResult"
                        class="bg-white border-2 border-dashed border-slate-200 p-12 rounded-2xl text-center flex flex-col items-center justify-center h-64 transition-all shadow-sm dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10 card-interactive">
                        <div class="bg-slate-50 p-4 rounded-full mb-4 dark:bg-white/5">
                            <i class="fa-solid fa-flask text-3xl text-slate-400"></i>
                        </div>
                        <h3 class="text-xl font-medium text-slate-500 dark:text-slate-400">Run prediction to see results
                        </h3>
                        <p class="text-sm text-slate-400 mt-2">AI model will analyze spoilage probability based on
                            biological markers.</p>
                    </div>

                    <!-- Recommendation Card (Hidden initially) -->
                    <div id="aiRecommendation"
                        class="hidden bg-blue-50 border border-blue-100 p-6 rounded-2xl flex items-start gap-4 fade-in shadow-sm dark:bg-cyan-900/20 dark:border-cyan-800/50">
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600 mt-1 shrink-0">
                            <i class="fa-solid fa-lightbulb"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg dark:text-white">AI Recommendation</h4>
                            <p id="recText" class="text-slate-600 text-sm mt-2 leading-relaxed dark:text-slate-300">
                                Humidity levels are critical. Recommend
                                installing dehumidifiers or selling 40% of stock within 7 days.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MARKET INTELLIGENCE SECTION -->
        <section id="view-market" class="hidden fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Market Price Forecast</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">AI-powered 30-day price projections to optimize
                    selling timing.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Controls -->
                <div
                    class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-soft border border-slate-100 h-fit dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10 card-interactive">
                    <h3 class="font-bold text-slate-800 mb-4 text-lg dark:text-white">Forecast Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Select
                                Crop</label>
                            <input list="marketCropOptions" id="marketCropSelect" onchange="updateMarketChart()"
                                placeholder="Search or select crop..." value="Wheat"
                                class="w-full rounded-lg border-slate-200 border p-3 bg-white focus:ring-2 focus:ring-secondary/20 focus:border-secondary focus:outline-none transition-all dark:bg-black/40 dark:border-white/10 dark:text-white dark:focus:ring-purple-500/50 dark:focus:border-purple-500">
                            <datalist id="marketCropOptions"></datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Mandi
                                Region</label>
                            <select id="mandiRegionSelect" onchange="updateMarketChart()"
                                class="w-full rounded-lg border-slate-200 border p-3 bg-white focus:ring-2 focus:ring-secondary/20 focus:border-secondary focus:outline-none transition-all dark:bg-black/40 dark:border-white/10 dark:text-white dark:focus:ring-purple-500/50 dark:focus:border-purple-500">
                                <option>Azadpur (Delhi)</option>
                                <option>Vashi (Mumbai)</option>
                                <option>Hapur (UP)</option>
                            </select>
                        </div>
                        <div class="pt-4 border-t border-slate-100 dark:border-white/10">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-500 dark:text-slate-400">Current Price</span>
                                <span class="font-bold text-xl text-slate-800 dark:text-white"
                                    id="currentPriceDisplay">‚Çπ2,150</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-500 dark:text-slate-400">Predicted Peak</span>
                                <span class="font-bold text-xl text-green-600" id="peakPriceDisplay">‚Çπ2,340</span>
                            </div>
                        </div>
                        <button onclick="updateMarketChart()"
                            class="w-full bg-secondary text-white py-3 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-[1.02] active:scale-[0.98] font-medium shadow-lg shadow-blue-700/20 dark:bg-purple-500/20 dark:text-purple-400 dark:border dark:border-purple-500/50 dark:hover:bg-purple-500/30 dark:shadow-[0_0_20px_rgba(168,85,247,0.2)]">
                            Refresh Forecast
                        </button>
                    </div>
                </div>

                <!-- Main Chart -->
                <div
                    class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-soft border border-slate-100 dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10 card-interactive">
                    <div class="relative h-96 w-full">
                        <canvas id="marketMainChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SOIL HEALTH SECTION -->
        <section id="view-soil" class="hidden fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Soil Health & Regeneration</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">Optimize crop rotation to restore soil nutrients.</p>
            </div>

            <div class="grid grid-cols-1 gap-8">
                <!-- Current Status -->
                <div
                    class="bg-white p-8 rounded-2xl shadow-soft border border-slate-100 dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10 card-interactive">
                    <h3 class="font-bold text-slate-800 mb-8 flex items-center text-lg dark:text-white">
                        <i class="fa-solid fa-flask text-primary mr-2"></i> Current NPK Levels
                    </h3>

                    <div class="space-y-6">
                        <!-- Nitrogen -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Nitrogen (N)</span>
                                <span class="text-sm font-medium text-yellow-600">Low (120 kg/ha)</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden dark:bg-white/10">
                                <div class="bg-yellow-500 h-3 rounded-full transition-all duration-1000 ease-out"
                                    style="width: 45%"></div>
                            </div>
                        </div>
                        <!-- Phosphorus -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Phosphorus
                                    (P)</span>
                                <span class="text-sm font-medium text-green-600">Optimal (45 kg/ha)</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden dark:bg-white/10">
                                <div class="bg-green-500 h-3 rounded-full transition-all duration-1000 ease-out"
                                    style="width: 75%"></div>
                            </div>
                        </div>
                        <!-- Potassium -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Potassium
                                    (K)</span>
                                <span class="text-sm font-medium text-green-600">Optimal (180 kg/ha)</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden dark:bg-white/10">
                                <div class="bg-green-500 h-3 rounded-full transition-all duration-1000 ease-out"
                                    style="width: 80%"></div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="mt-8 p-4 bg-yellow-50 rounded-lg text-sm border-l-4 border-yellow-500 dark:bg-yellow-900/20">
                        <p class="text-yellow-800 dark:text-yellow-200"><strong>Alert:</strong> Nitrogen depletion
                            detected due to successive
                            Wheat cycles. Recommend leguminous crop rotation.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ROTATION PLAN SECTION -->
        <section id="view-rotation" class="hidden fade-in">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Crop Rotation Plan</h1>
                <p class="text-slate-500 mt-1 dark:text-slate-400">AI-driven recommendations for sustainable farming.
                </p>
            </div>
            <div
                class="bg-white p-8 rounded-2xl shadow-soft border border-slate-100 dark:bg-slate-900/60 dark:backdrop-blur-xl dark:border-white/10 card-interactive">
                <!-- AI Rotation Planner -->
                <h3 class="font-bold text-slate-800 mb-8 flex items-center text-lg dark:text-white">
                    <i class="fa-solid fa-rotate text-blue-600 mr-2"></i> Recommended Rotation Plan
                </h3>

                <div class="relative pl-8 border-l-2 border-slate-200 space-y-10 dark:border-white/10">
                    <!-- Step 1 -->
                    <div class="relative">
                        <div class="absolute -left-[41px] top-0 bg-white p-1 dark:bg-transparent">
                            <div class="w-4 h-4 bg-blue-600 rounded-full ring-4 ring-blue-100"></div>
                        </div>
                        <h4 class="font-bold text-slate-900 text-lg dark:text-white">Next Season: Chickpea (Legume)</h4>
                        <p class="text-sm text-slate-500 mb-3 dark:text-slate-400">Oct 2026 - Mar 2027</p>
                        <span
                            class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full dark:bg-green-900/30 dark:text-green-400">Restores
                            Nitrogen (+30kg/ha)</span>
                    </div>
                    <!-- Step 2 -->
                    <div class="relative">
                        <div class="absolute -left-[41px] top-0 bg-white p-1 dark:bg-transparent">
                            <div class="w-4 h-4 bg-slate-300 rounded-full"></div>
                        </div>
                        <h4 class="font-bold text-slate-900 text-lg dark:text-white">Season 2: Maize (Cover Crop)</h4>
                        <p class="text-sm text-slate-500 mb-3 dark:text-slate-400">Apr 2027 - Jul 2027</p>
                        <span
                            class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full dark:bg-blue-900/30 dark:text-blue-400">Biomass
                            Retention</span>
                    </div>
                    <!-- Step 3 -->
                    <div class="relative">
                        <div class="absolute -left-[41px] top-0 bg-white p-1 dark:bg-transparent">
                            <div class="w-4 h-4 bg-slate-300 rounded-full"></div>
                        </div>
                        <h4 class="font-bold text-slate-900 text-lg dark:text-white">Season 3: Wheat (Cash Crop)</h4>
                        <p class="text-sm text-slate-500 mb-3 dark:text-slate-400">Oct 2027 - Mar 2028</p>
                        <span
                            class="inline-block bg-yellow-100 text-yellow-800 text-xs font-semibold px-3 py-1 rounded-full dark:bg-yellow-900/30 dark:text-yellow-400">Maximum
                            Yield Potential</span>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- SCRIPTS -->
    <script>
        // --- API Configuration ---
        const GOOGLE_API_KEY = 'AIzaSyCu0-7NvRVJ4q66Us5MlQcG3Fr_Ymqn9LI'; // Gemini API Key

        // --- Chart Configuration Helper ---
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = '#f1f5f9';
        Chart.defaults.scale.grid.borderColor = 'transparent';

        // --- Navigation Logic ---
        function switchTab(tabId) {
            console.log("Switching to tab:", tabId);
            ['dashboard', 'spoilage', 'market', 'soil', 'rotation'].forEach(id => {
                const view = document.getElementById('view-' + id);
                const tab = document.getElementById('tab-' + id);

                if (view && tab) {
                    view.classList.add('hidden');
                    tab.classList.remove('active-tab');
                    tab.classList.add('text-slate-500', 'hover:text-primary', 'hover:bg-slate-50', 'dark:text-slate-400', 'dark:hover:text-cyan-400', 'dark:hover:bg-white/5');
                }
            });

            const activeView = document.getElementById('view-' + tabId);
            const activeTab = document.getElementById('tab-' + tabId);
            const mobileMenu = document.getElementById('mobile-menu');

            if (activeView && activeTab) {
                activeView.classList.remove('hidden');
                // Re-trigger animation for smoother transition
                activeView.classList.remove('fade-in');
                void activeView.offsetWidth; // Trigger reflow
                activeView.classList.add('fade-in');

                activeTab.classList.add('active-tab');
                activeTab.classList.remove('text-slate-500', 'hover:text-primary', 'hover:bg-slate-50', 'dark:text-slate-400', 'dark:hover:text-cyan-400', 'dark:hover:bg-white/5');
            }

            if (mobileMenu) mobileMenu.classList.add('hidden');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        function enterApp() {
            const overlay = document.getElementById('login-overlay');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => overlay.remove(), 500);
        }

        // --- Location Management ---
        let userLocation = {
            lat: 28.6139, // Default: Delhi
            lng: 77.2090,
            address: 'Delhi, India',
            isAutoDetected: false
        };

        let map = null;
        let marker = null;
        let routeLayer = null;
        let destMarker = null;

        // Request automatic geolocation
        function requestGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation.lat = position.coords.latitude;
                        userLocation.lng = position.coords.longitude;
                        userLocation.isAutoDetected = true;

                        // Update map if it exists
                        if (map && marker) {
                            map.setView([userLocation.lat, userLocation.lng], 13);
                            marker.setLatLng([userLocation.lat, userLocation.lng]);
                        }

                        reverseGeocode(userLocation.lat, userLocation.lng);
                        updateLocationDisplay();
                    },
                    (error) => {
                        console.log('Geolocation denied or failed:', error);
                        alert('Unable to get your location. Please select manually on the map.');
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser. Please select location manually.');
            }
        }

        // Reverse geocode coordinates to address using Nominatim (OpenStreetMap)
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();

                if (data && data.display_name) {
                    userLocation.address = data.display_name;
                    updateLocationDisplay();
                }
            } catch (error) {
                console.error('Reverse geocoding failed:', error);
                userLocation.address = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                updateLocationDisplay();
            }
        }

        // Initialize Leaflet Map with OpenStreetMap
        function initializeMap() {
            // Create map
            map = L.map('map').setView([userLocation.lat, userLocation.lng], 12);

            // Add OpenStreetMap tile layer (Free!)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add satellite imagery option (ESRI World Imagery - Free!)
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 19
            });

            // Layer control to switch between map types
            const baseMaps = {
                "Street Map": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }),
                "Satellite": satelliteLayer
            };

            L.control.layers(baseMaps).addTo(map);

            // Add marker
            marker = L.marker([userLocation.lat, userLocation.lng], {
                draggable: true,
                title: 'Farm Location'
            }).addTo(map);

            // Update location on marker drag
            marker.on('dragend', function (event) {
                const position = marker.getLatLng();
                userLocation.lat = position.lat;
                userLocation.lng = position.lng;
                reverseGeocode(userLocation.lat, userLocation.lng);
            });

            // Update location on map click
            map.on('click', function (event) {
                userLocation.lat = event.latlng.lat;
                userLocation.lng = event.latlng.lng;
                marker.setLatLng(event.latlng);
                reverseGeocode(userLocation.lat, userLocation.lng);
            });

            // Add search functionality using Nominatim
            const searchInput = document.getElementById('locationSearch');
            searchInput.addEventListener('keypress', async function (e) {
                if (e.key === 'Enter') {
                    const query = searchInput.value;
                    if (query.trim()) {
                        await searchLocation(query);
                    }
                }
            });
        }

        // Search for location using Nominatim (OpenStreetMap)
        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0];
                    userLocation.lat = parseFloat(result.lat);
                    userLocation.lng = parseFloat(result.lon);
                    userLocation.address = result.display_name;

                    if (map && marker) {
                        map.setView([userLocation.lat, userLocation.lng], 13);
                        marker.setLatLng([userLocation.lat, userLocation.lng]);
                    }

                    updateLocationDisplay();
                } else {
                    alert('Location not found. Please try a different search term.');
                }
            } catch (error) {
                console.error('Location search failed:', error);
                alert('Search failed. Please try again.');
            }
        }

        // Handle search button click
        function handleSearchClick() {
            const searchInput = document.getElementById('locationSearch');
            const query = searchInput.value.trim();
            if (query) {
                searchLocation(query);
            } else {
                alert('Please enter a location to search.');
            }
        }

        // Toggle location map overlay
        function toggleLocationMap() {
            const overlay = document.getElementById('locationMapOverlay');
            const isHidden = overlay.classList.contains('hidden');
            overlay.classList.toggle('hidden');

            if (isHidden) {
                // Opening map - reset route if any
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                if (destMarker) {
                    map.removeLayer(destMarker);
                    destMarker = null;
                }

                // Initialize map when shown for the first time
                if (!map) {
                    setTimeout(() => initializeMap(), 100); // Small delay for DOM rendering
                } else {
                    map.invalidateSize();
                    // Re-center map to current location using Leaflet API
                    map.setView([userLocation.lat, userLocation.lng], 12);
                    marker.setLatLng([userLocation.lat, userLocation.lng]);
                }
                updateLocationDisplay();
            }
        }

        function showRouteToFacility(lat, lng, name) {
            const overlay = document.getElementById('locationMapOverlay');
            overlay.classList.remove('hidden');

            if (!map) {
                setTimeout(() => {
                    initializeMap();
                    drawRoute(lat, lng, name);
                }, 100);
            } else {
                setTimeout(() => {
                    map.invalidateSize();
                    drawRoute(lat, lng, name);
                }, 100);
            }
        }

        function drawRoute(lat, lng, name) {
            if (routeLayer) map.removeLayer(routeLayer);
            if (destMarker) map.removeLayer(destMarker);

            destMarker = L.marker([lat, lng]).addTo(map).bindPopup(`<b>${name}</b><br>Destination`).openPopup();
            
            const latlngs = [[userLocation.lat, userLocation.lng], [lat, lng]];
            routeLayer = L.polyline(latlngs, {color: 'blue', weight: 4, opacity: 0.7, dashArray: '10, 10'}).addTo(map);
            map.fitBounds(L.latLngBounds(latlngs), {padding: [50, 50]});
        }

        // Confirm location selection
        function confirmLocation() {
            updateLocationDisplay();
            fetchLocationBasedSoilData();
            toggleLocationMap();

            // Show success message
            const locationText = userLocation.address.length > 50
                ? userLocation.address.substring(0, 50) + '...'
                : userLocation.address;
            alert(`‚úÖ Location set to: ${locationText}\n\nFetching soil data for this region...`);
        }

        // Update location display in UI
        function updateLocationDisplay() {
            // Update dashboard location text
            const dashLocationText = document.getElementById('dashLocationText');
            if (dashLocationText) {
                const shortAddress = userLocation.address.split(',').slice(-2).join(',').trim();
                dashLocationText.textContent = shortAddress || userLocation.address;
            }

            // Update modal location display
            const selectedLocationText = document.getElementById('selectedLocationText');
            const selectedCoordinates = document.getElementById('selectedCoordinates');

            if (selectedLocationText) {
                selectedLocationText.textContent = userLocation.address;
            }

            if (selectedCoordinates) {
                const latDir = userLocation.lat >= 0 ? 'N' : 'S';
                const lngDir = userLocation.lng >= 0 ? 'E' : 'W';
                selectedCoordinates.textContent =
                    `${Math.abs(userLocation.lat).toFixed(4)}¬∞${latDir}, ${Math.abs(userLocation.lng).toFixed(4)}¬∞${lngDir}`;
            }
        }

        // Fetch location-based soil data using open-source SoilGrids API
        async function fetchLocationBasedSoilData() {
            try {
                // SoilGrids REST API (ISRIC World Soil Information)
                // Fetches nitrogen content at 0-5cm depth
                const soilGridsUrl = `https://rest.isric.org/soilgrids/v2.0/properties/query?lon=${userLocation.lng}&lat=${userLocation.lat}&property=nitrogen&depth=0-5cm&value=mean`;

                const response = await fetch(soilGridsUrl);
                const data = await response.json();

                // Extract nitrogen value (in cg/kg, convert to kg/ha)
                // SoilGrids returns nitrogen in cg/kg (centigrade per kilogram)
                // Typical conversion: cg/kg * 10 = kg/ha (approximate)
                let nitrogenValue = 142; // Default fallback

                if (data && data.properties && data.properties.layers && data.properties.layers.length > 0) {
                    const nitrogenData = data.properties.layers[0];
                    if (nitrogenData && nitrogenData.depths && nitrogenData.depths.length > 0) {
                        const depthData = nitrogenData.depths[0];
                        if (depthData && depthData.values && depthData.values.mean !== undefined) {
                            // Convert from cg/kg to kg/ha (multiply by 10 for approximation)
                            nitrogenValue = Math.round(depthData.values.mean * 10);
                        }
                    }
                }

                // Create soil data object with real nitrogen value
                const soilData = {
                    nitrogen: nitrogenValue,
                    source: 'SoilGrids (ISRIC)',
                    coordinates: `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`
                };

                // Update soil health section with location-based data
                updateSoilHealthDisplay(soilData);

                console.log('Location-based soil data fetched from SoilGrids:', soilData);
            } catch (error) {
                console.error('Error fetching soil data from SoilGrids:', error);

                // Fallback: Use default value
                const fallbackData = {
                    nitrogen: 142,
                    source: 'Default (API unavailable)',
                    coordinates: `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`
                };

                updateSoilHealthDisplay(fallbackData);
                console.log('Using fallback soil data:', fallbackData);
            }
        }

        // Update soil health display with fetched data
        function updateSoilHealthDisplay(soilData) {
            // Update nitrogen value on dashboard
            const dashNitrogenValue = document.getElementById('dashNitrogenValue');
            if (dashNitrogenValue && soilData.nitrogen) {
                dashNitrogenValue.textContent = Math.round(soilData.nitrogen);
            }

            console.log('Soil health data updated:', soilData);

            // Fetch and update cold storage facilities for this location
            fetchColdStorageData();
        }

        // Calculate distance between two coordinates in km (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in km
            return d.toFixed(1);
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // Fetch location-based cold storage facilities using OpenStreetMap (Nominatim)
        async function fetchColdStorageData() {
            try {
                // Search for "cold storage" near the user's location
                // Nominatim Search API
                const searchUrl = `https://nominatim.openstreetmap.org/search?format=json&q=cold+storage&lat=${userLocation.lat}&lon=${userLocation.lng}&limit=6&addressdetails=1`;

                const response = await fetch(searchUrl);
                const results = await response.json();

                // Process results
                const facilities = results.map(item => {
                    return {
                        name: item.name || item.display_name.split(',')[0],
                        address: item.display_name,
                        distance: calculateDistance(userLocation.lat, userLocation.lng, parseFloat(item.lat), parseFloat(item.lon)),
                        contacts: "Contact Facility", // Placeholder as OSM often lacks phone numbers
                        source: "OpenStreetMap",
                        lat: parseFloat(item.lat),
                        lon: parseFloat(item.lon)
                    };
                }).sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance)); // Sort by distance

                // Determine region from first result or user location
                let region = "Nearby Region";
                if (results.length > 0 && results[0].address) {
                    region = results[0].address.city || results[0].address.state_district || results[0].address.state || "Nearby";
                } else if (userLocation.address) {
                    // Fallback to user's address parts
                    const parts = userLocation.address.split(',');
                    region = parts.length > 2 ? parts[parts.length - 3] : "Local Region";
                }

                const coldStorageData = {
                    region: region,
                    facilities: facilities
                };

                // Update cold storage display
                updateColdStorageDisplay(coldStorageData);

                console.log('Cold storage data fetched from OSM:', coldStorageData);
            } catch (error) {
                console.error('Error fetching cold storage data from OSM:', error);

                // Show empty state or error
                const emptyData = {
                    region: "Unknown Region",
                    facilities: []
                };
                updateColdStorageDisplay(emptyData);
            }
        }

        // Update cold storage display with fetched real data
        function updateColdStorageDisplay(data) {
            // Update region name
            const locationElement = document.getElementById('coldStorageLocation');
            if (locationElement) {
                locationElement.textContent = data.region;
            }

            // Update facility count
            const countElement = document.getElementById('coldStorageCount');
            if (countElement) {
                countElement.textContent = data.facilities ? data.facilities.length : 0;
            }

            // Update facilities grid
            const gridElement = document.getElementById('coldStorageGrid');
            if (gridElement) {
                if (data.facilities && data.facilities.length > 0) {
                    const colors = [
                        { bg: 'bg-blue-50 dark:bg-blue-500/10', text: 'text-blue-600 dark:text-blue-400' },
                        { bg: 'bg-green-50 dark:bg-green-500/10', text: 'text-green-600 dark:text-green-400' },
                        { bg: 'bg-purple-50 dark:bg-purple-500/10', text: 'text-purple-600 dark:text-purple-400' }
                    ];

                    gridElement.innerHTML = data.facilities.slice(0, 3).map((facility, index) => { // Show max 3
                        const color = colors[index % colors.length];
                        return `
                            <div onclick="showRouteToFacility(${facility.lat}, ${facility.lon}, '${facility.name.replace(/'/g, "\\'")}')" class="border border-slate-200 dark:border-slate-700 rounded-xl p-4 hover:shadow-md transition-shadow cursor-pointer group">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold text-slate-900 dark:text-white line-clamp-1 group-hover:text-blue-600 transition-colors" title="${facility.name}">${facility.name}</h4>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                            <i class="fa-solid fa-location-arrow text-blue-500"></i> ${facility.distance} km away
                                        </p>
                                    </div>
                                    <div class="p-2 ${color.bg} rounded-lg">
                                        <i class="fa-solid fa-warehouse ${color.text}"></i>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600 dark:text-slate-400">Rate:</span>
                                        <span class="font-semibold text-slate-900 dark:text-white">Contact for Price</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-slate-600 dark:text-slate-400">Capacity:</span>
                                        <span class="font-medium text-slate-700 dark:text-slate-300">Start Inquiry</span>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
                                        <p class="text-xs text-slate-500 dark:text-slate-400 text-ellipsis overflow-hidden whitespace-nowrap" title="${facility.address}">
                                            <i class="fa-solid fa-map-pin text-green-600"></i> ${facility.address}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    gridElement.innerHTML = `
                        <div class="col-span-3 text-center p-8 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                            <i class="fa-solid fa-warehouse text-4xl text-slate-300 mb-3"></i>
                            <p class="text-slate-500">No cold storage facilities found nearby.</p>
                            <p class="text-xs text-slate-400 mt-1">Try searching for a major city or district center.</p>
                        </div>
                    `;
                }
            }
        }

        // --- Spoilage Prediction Logic ---
        function predictSpoilage(e) {
            e.preventDefault();

            const cropType = document.getElementById('cropType').value.trim();
            const temp = parseFloat(document.getElementById('tempInput').value);
            const humidity = parseFloat(document.getElementById('humidityInput').value);
            const days = parseInt(document.getElementById('durationInput').value);

            // Validate crop type is not empty
            if (!cropType) {
                alert('Please enter a crop name before predicting spoilage risk.');
                document.getElementById('cropType').focus();
                return;
            }

            // Validate crop name against known crops
            const validation = validateCrop(cropType);
            if (!validation.valid) {
                alert(`‚ùå "${cropType}" is not a recognized crop.\n\nPlease enter a valid crop name from the list.\n\nExamples: Wheat, Rice, Tomato, Onion, Potato, etc.`);
                document.getElementById('cropType').focus();
                return;
            }

            // Use normalized crop name
            const normalizedCrop = validation.normalizedName;
            document.getElementById('cropType').value = normalizedCrop; // Update input with proper case

            // Heuristic Model
            let risk = (temp * 0.8) + (humidity * 0.5) + (days * 1.5);
            risk = Math.min(Math.max(risk - 20, 5), 99);

            const isHighRisk = risk > 50;
            const colorClass = isHighRisk ? 'text-red-600' : 'text-green-600';
            const bgClass = isHighRisk ? 'bg-red-50 dark:bg-red-500/10' : 'bg-green-50 dark:bg-emerald-500/10';
            const icon = isHighRisk ? '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-circle-check text-green-500"></i>';

            const resDiv = document.getElementById('predictionResult');
            resDiv.innerHTML = `
                <div class="${bgClass} w-full h-full rounded-2xl flex flex-col justify-center items-center relative overflow-hidden fade-in px-4">
                    <div class="absolute top-4 right-4 text-2xl">${icon}</div>
                    <p class="text-slate-500 font-medium mb-1 dark:text-slate-400">Spoilage Probability</p>
                    <h2 class="text-5xl font-bold ${colorClass} mb-2">${risk.toFixed(1)}%</h2>
                    <p class="text-sm text-slate-500 mb-4 dark:text-slate-400">Safe Storage Window: <span class="font-bold text-slate-800 dark:text-white">${Math.max(0, 30 - (temp / 2)).toFixed(0)} Days</span></p>
                    
                    <div class="w-full max-w-xs bg-white/50 dark:bg-white/10 rounded-full h-2">
                        <div class="${isHighRisk ? 'bg-red-500' : 'bg-green-500'} h-2 rounded-full transition-all duration-1000" style="width: ${risk}%"></div>
                    </div>
                </div>
            `;
            resDiv.classList.remove('border-2', 'border-dashed', 'p-12');
            resDiv.classList.add('p-0', 'border-0');

            // Recommendation
            const recText = isHighRisk
                ? `Critical humidity levels detected. Recommend reducing storage temp to ${(temp - 5).toFixed(1)}¬∞C or selling stock within 3 days.`
                : `Conditions are optimal. You can safely store this batch for the next 2-3 weeks to wait for better market prices.`;

            const aiRec = document.getElementById('aiRecommendation');
            document.getElementById('recText').innerText = recText;
            aiRec.classList.remove('hidden');

            // Update Dashboard Spoilage Risk Card
            const dashRisk = document.getElementById('dashSpoilageRisk');
            const dashIcon = document.getElementById('dashSpoilageIcon');
            const dashDetail = document.getElementById('dashSpoilageDetail');

            if (dashRisk && dashIcon && dashDetail) {
                // Determine risk level
                let riskLevel, riskColor, riskBgColor, riskIcon, riskDetailText;

                if (risk >= 70) {
                    riskLevel = 'High';
                    riskColor = 'text-red-600 dark:text-red-400';
                    riskBgColor = 'bg-red-50 text-red-600 dark:bg-red-500/10 dark:text-red-400';
                    riskIcon = 'fa-triangle-exclamation';
                    riskDetailText = `<i class="fa-solid fa-arrow-up mr-1"></i> Critical risk <span class="text-slate-400 font-normal ml-2">${risk.toFixed(1)}%</span>`;
                } else if (risk >= 40) {
                    riskLevel = 'Medium';
                    riskColor = 'text-yellow-600 dark:text-yellow-400';
                    riskBgColor = 'bg-yellow-50 text-yellow-600 dark:bg-yellow-500/10 dark:text-yellow-400';
                    riskIcon = 'fa-exclamation-circle';
                    riskDetailText = `<i class="fa-solid fa-minus mr-1"></i> Moderate risk <span class="text-slate-400 font-normal ml-2">${risk.toFixed(1)}%</span>`;
                } else {
                    riskLevel = 'Low';
                    riskColor = 'text-green-600 dark:text-green-400';
                    riskBgColor = 'bg-green-50 text-green-600 dark:bg-green-500/10 dark:text-green-400';
                    riskIcon = 'fa-check-circle';
                    riskDetailText = `<i class="fa-solid fa-arrow-down mr-1"></i> Low risk <span class="text-slate-400 font-normal ml-2">${risk.toFixed(1)}%</span>`;
                }

                // Update dashboard elements
                dashRisk.textContent = riskLevel;
                dashRisk.className = `text-3xl font-bold mt-2 ${riskColor}`;

                dashIcon.className = `p-3 rounded-xl ${riskBgColor}`;
                dashIcon.innerHTML = `<i class="fa-solid ${riskIcon}"></i>`;

                dashDetail.className = `flex items-center text-sm ${riskColor} font-medium`;
                dashDetail.innerHTML = riskDetailText;
            }
        }

        // --- Market Chart Logic ---
        let marketChartInstance = null;
        let dashboardMarketChartInstance = null;

        // Extensive Crop List
        const allCrops = [
            "Wheat", "Rice", "Maize", "Barley", "Sorghum", "Millet", "Oats", "Rye", "Triticale", "Quinoa",
            "Chickpea", "Pigeon pea", "Lentil", "Field pea", "Cowpea", "Black gram", "Green gram", "Kidney bean", "Soybean",
            "Groundnut", "Mustard", "Rapeseed", "Sesame", "Sunflower", "Safflower", "Linseed", "Castor",
            "Potato", "Onion", "Tomato", "Brinjal", "Cabbage", "Cauliflower", "Okra", "Carrot", "Radish",
            "Spinach", "Lettuce", "Pumpkin", "Bottle gourd", "Bitter gourd", "Cucumber", "Watermelon", "Muskmelon",
            "Peas", "Beans", "Chili", "Capsicum", "Garlic", "Ginger", "Turmeric", "Coriander", "Cumin",
            "Mango", "Banana", "Orange", "Lemon", "Lime", "Apple", "Grape", "Guava", "Papaya", "Pineapple",
            "Pomegranate", "Sapota", "Jackfruit", "Litchi", "Strawberry", "Pear", "Peach", "Plum", "Apricot",
            "Sugarcane", "Cotton", "Jute", "Tobacco", "Tea", "Coffee", "Rubber", "Cocoa", "Arecanut",
            "Black pepper", "Cardamom", "Clove", "Cinnamon", "Nutmeg", "Vanilla", "Saffron", "Asafoetida",
            "Almond", "Cashew", "Walnut", "Pistachio", "Date", "Fig", "Coconut", "Bamboo", "Aloe Vera",
            "Tulsi", "Mint", "Lemongrass", "Rose", "Jasmine", "Marigold", "Gerbera", "Gladiolus", "Orchid",
            "Mushroom", "Betel leaf", "Curry leaf", "Drumstick", "Sweet potato", "Tapioca", "Yam", "Colocasia",
            "Amaranth", "Fenugreek", "Fennel", "Ajwain", "Dill", "Celery", "Parsley", "Leek", "Broccoli",
            "Zucchini", "Asparagus", "Artichoke", "Brussels sprout", "Kale", "Swiss chard", "Turnip", "Beetroot",
            "Radish", "Carrot", "Sweet corn", "Baby corn", "Popcorn", "Finger millet", "Pearl millet", "Foxtail millet",
            "Kodo millet", "Little millet", "Barnyard millet", "Proso millet", "Buckwheat", "Amaranth grain"
        ].sort();

        const marketData = {
            'Wheat': {
                'Azadpur (Delhi)': { current: 2150, peak: 2340, trend: [2100, 2150, 2180, 2240, 2300, 2280, 2340] },
                'Vashi (Mumbai)': { current: 2280, peak: 2450, trend: [2220, 2280, 2310, 2370, 2420, 2400, 2450] },
                'Hapur (UP)': { current: 2100, peak: 2300, trend: [2050, 2100, 2130, 2190, 2250, 2230, 2300] }
            },
            'Rice': {
                'Azadpur (Delhi)': { current: 3500, peak: 3800, trend: [3400, 3450, 3500, 3600, 3650, 3750, 3800] },
                'Vashi (Mumbai)': { current: 3650, peak: 3900, trend: [3550, 3600, 3650, 3750, 3800, 3850, 3900] },
                'Hapur (UP)': { current: 3450, peak: 3750, trend: [3350, 3400, 3450, 3550, 3600, 3700, 3750] }
            },
            'Mustard': {
                'Azadpur (Delhi)': { current: 5400, peak: 5200, trend: [5500, 5450, 5400, 5300, 5250, 5200, 5150] },
                'Vashi (Mumbai)': { current: 5550, peak: 5350, trend: [5650, 5600, 5550, 5450, 5400, 5350, 5300] },
                'Hapur (UP)': { current: 5300, peak: 5100, trend: [5400, 5350, 5300, 5200, 5150, 5100, 5050] }
            },
            'Onion': {
                'Azadpur (Delhi)': { current: 1800, peak: 2500, trend: [1600, 1700, 1800, 2000, 2200, 2400, 2500] },
                'Vashi (Mumbai)': { current: 1950, peak: 2650, trend: [1750, 1850, 1950, 2150, 2350, 2550, 2650] },
                'Hapur (UP)': { current: 1750, peak: 2450, trend: [1550, 1650, 1750, 1950, 2150, 2350, 2450] }
            }
        };

        // Validate crop name against known crops list
        function validateCrop(cropName) {
            if (!cropName || cropName.trim() === '') {
                return { valid: false, normalizedName: null };
            }

            const trimmedCrop = cropName.trim();
            // Case-insensitive search in allCrops array
            const foundCrop = allCrops.find(crop => crop.toLowerCase() === trimmedCrop.toLowerCase());

            if (foundCrop) {
                return { valid: true, normalizedName: foundCrop };
            }

            return { valid: false, normalizedName: null };
        }


        async function fetchMarketData(crop, region) {
            const prompt = `Generate realistic market price data for ${crop} in ${region} mandi in India (in INR/quintal). Consider regional factors like transportation costs, local supply-demand, and market infrastructure. Return ONLY a valid JSON object with the following structure: { "current": <current_price_number>, "peak": <predicted_peak_price_number>, "trend": [<price_day_1>, <price_day_2>, <price_day_3>, <price_day_4>, <price_day_5>, <price_day_6>, <price_day_7>] }. The trend should represent the last 7 days. Ensure the data is realistic for ${region} market conditions.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(jsonString);
            } catch (error) {
                console.error("Error fetching market data:", error);
                return null;
            }
        }

        async function updateMarketChart() {
            const cropInput = document.getElementById('marketCropSelect').value;

            // Validate crop name
            const validation = validateCrop(cropInput);

            if (!validation.valid) {
                // Show error message for invalid crop
                const ctx = document.getElementById('marketMainChart').getContext('2d');

                if (marketChartInstance) {
                    marketChartInstance.destroy();
                }

                // Clear price displays
                document.getElementById('currentPriceDisplay').innerText = '---';
                document.getElementById('peakPriceDisplay').innerText = '---';

                // Update dashboard elements
                const dashTitle = document.getElementById('dashMarketTitle');
                const dashPrice = document.getElementById('dashMarketPrice');
                const dashChartTitle = document.getElementById('dashMarketChartTitle');

                if (dashTitle) dashTitle.innerText = 'Market Price';
                if (dashPrice) dashPrice.innerText = '---';
                if (dashChartTitle) dashChartTitle.innerText = 'Price Forecast';

                // Display error message in chart area
                alert(`‚ùå No data available for "${cropInput}".\n\nPlease select a valid crop from the list.\n\nExamples: Wheat, Rice, Tomato, Onion, Potato, etc.`);

                // Focus back on input
                document.getElementById('marketCropSelect').focus();
                return;
            }

            // Use normalized crop name
            const crop = validation.normalizedName;
            document.getElementById('marketCropSelect').value = crop; // Update input with proper case

            // Get selected region
            const region = document.getElementById('mandiRegionSelect').value;

            // Access region-specific data
            let data = marketData[crop] ? marketData[crop][region] : null;

            // Fallback for crops not in static database
            if (!data) {
                const btn = document.querySelector('button[onclick="updateMarketChart()"]');
                const originalText = btn ? btn.innerText : 'Refresh Forecast';
                if (btn) { btn.innerText = 'AI Fetching...'; btn.disabled = true; }

                data = await fetchMarketData(crop, region);

                // Cache the data in nested structure
                if (data) {
                    if (!marketData[crop]) {
                        marketData[crop] = {};
                    }
                    marketData[crop][region] = data;
                }

                if (btn) { btn.innerText = originalText; btn.disabled = false; }

                if (!data) {
                    // Fallback if API fails - deterministic based on crop name and region
                    const basePrice = 1000 + (crop.length * 150);
                    // Add regional variation: Mumbai +6%, UP -3%, Delhi baseline
                    const regionMultiplier = region.includes('Mumbai') ? 1.06 : region.includes('UP') ? 0.97 : 1.0;
                    const adjustedBase = Math.floor(basePrice * regionMultiplier);
                    const trend = Array.from({ length: 7 }, (_, i) => Math.floor(adjustedBase + (i * 20)));
                    data = {
                        current: trend[6],
                        peak: Math.floor(Math.max(...trend) + 100),
                        trend: trend
                    };
                    // Cache the generated data
                    if (!marketData[crop]) {
                        marketData[crop] = {};
                    }
                    marketData[crop][region] = data;
                }
            }

            // Update Text
            document.getElementById('currentPriceDisplay').innerText = `‚Çπ${data.current.toLocaleString()}`;
            document.getElementById('peakPriceDisplay').innerText = `‚Çπ${data.peak.toLocaleString()}`;

            // Update Dashboard Elements
            const dashTitle = document.getElementById('dashMarketTitle');
            const dashPrice = document.getElementById('dashMarketPrice');
            const dashChartTitle = document.getElementById('dashMarketChartTitle');

            if (dashTitle) dashTitle.innerText = `Market Price (${crop})`;
            if (dashPrice) dashPrice.innerText = `‚Çπ${data.current.toLocaleString()}`;
            if (dashChartTitle) dashChartTitle.innerText = `${crop} Price Forecast`;

            // Update Chart
            const ctx = document.getElementById('marketMainChart').getContext('2d');

            if (marketChartInstance) {
                marketChartInstance.destroy();
            }

            // Create Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(43, 108, 176, 0.2)');
            gradient.addColorStop(1, 'rgba(43, 108, 176, 0)');

            const labels = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() + (i * 5));
                labels.push(d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }));
            }

            marketChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Forecasted Price: ${crop} (‚Çπ/q)`,
                        data: data.trend,
                        borderColor: '#2B6CB0',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: (val) => '‚Çπ' + val },
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Update Dashboard Chart if initialized
            if (dashboardMarketChartInstance) {
                dashboardMarketChartInstance.data.datasets[0].label = `${crop} Price`;
                dashboardMarketChartInstance.data.datasets[0].data = data.trend.slice(0, 4);
                dashboardMarketChartInstance.update();
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function () {
            // Populate Crop Datalists
            const cropOptions = document.getElementById('cropOptions');
            const marketCropOptions = document.getElementById('marketCropOptions');

            allCrops.forEach(crop => {
                const option = document.createElement('option');
                option.value = crop;
                cropOptions.appendChild(option.cloneNode(true));
                marketCropOptions.appendChild(option);
            });

            // Init Dashboard Charts
            const ctxStorage = document.getElementById('storageChart').getContext('2d');

            // Gradients
            const gradTemp = ctxStorage.createLinearGradient(0, 0, 0, 300);
            gradTemp.addColorStop(0, 'rgba(197, 48, 48, 0.2)');
            gradTemp.addColorStop(1, 'rgba(197, 48, 48, 0)');

            const gradHum = ctxStorage.createLinearGradient(0, 0, 0, 300);
            gradHum.addColorStop(0, 'rgba(47, 133, 90, 0.2)');
            gradHum.addColorStop(1, 'rgba(47, 133, 90, 0)');

            new Chart(ctxStorage, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: [24, 25, 25, 26, 28, 27, 26],
                        borderColor: '#C53030', // Red
                        backgroundColor: gradTemp,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }, {
                        label: 'Humidity (%)',
                        data: [55, 58, 60, 62, 65, 63, 60],
                        borderColor: '#2F855A', // Green
                        backgroundColor: gradHum,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } } },
                    scales: { x: { grid: { display: false } }, y: { grid: { borderDash: [4, 4], color: '#f1f5f9' } } },
                    interaction: { mode: 'index', intersect: false }
                }
            });

            const ctxMarketDash = document.getElementById('marketChartDashboard').getContext('2d');

            const gradMarket = ctxMarketDash.createLinearGradient(0, 0, 0, 300);
            gradMarket.addColorStop(0, 'rgba(214, 158, 46, 0.2)');
            gradMarket.addColorStop(1, 'rgba(214, 158, 46, 0)');

            dashboardMarketChartInstance = new Chart(ctxMarketDash, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Wheat Price',
                        data: marketData['Wheat']['Azadpur (Delhi)'].trend.slice(0, 4),
                        borderColor: '#D69E2E', // Yellow
                        backgroundColor: gradMarket,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { display: false } }
                }
            });

            // Init Market Module Chart
            updateMarketChart();
        });

        function toggleTheme(event) {
            // Check if View Transitions API is supported
            if (!document.startViewTransition) {
                performToggle();
                return;
            }

            const x = event ? event.clientX : window.innerWidth / 2;
            const y = event ? event.clientY : window.innerHeight / 2;

            const endRadius = Math.hypot(
                Math.max(x, window.innerWidth - x),
                Math.max(y, window.innerHeight - y)
            );

            const transition = document.startViewTransition(() => {
                performToggle();
            });

            transition.ready.then(() => {
                const clipPath = [
                    `circle(0px at ${x}px ${y}px)`,
                    `circle(${endRadius}px at ${x}px ${y}px)`,
                ];
                document.documentElement.animate(
                    {
                        clipPath: clipPath,
                    },
                    {
                        duration: 500,
                        easing: 'ease-in',
                        pseudoElement: '::view-transition-new(root)',
                    }
                );
            });
        }

        function performToggle() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            }
        }
    </script>

    <!-- Location Map Overlay Modal -->
    <div id="locationMapOverlay"
        class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div
                class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-900 z-10">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Set Farm Location</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Click on the map or search for your farm
                        location</p>
                </div>
                <button onclick="toggleLocationMap()"
                    class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                    <i class="fa-solid fa-times text-xl text-slate-600 dark:text-slate-400"></i>
                </button>
            </div>

            <!-- Map Container -->
            <div id="map" class="w-full h-[350px] bg-slate-100 dark:bg-slate-800"></div>

            <!-- Controls -->
            <div class="p-6 border-t border-slate-200 dark:border-slate-700 space-y-4">
                <!-- Search Box -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">
                        üîç Search Location
                    </label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <i
                                class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400 text-lg"></i>
                            <input id="locationSearch" type="text"
                                placeholder="Type location (e.g., Mumbai, India) and press Enter or click Search"
                                class="w-full pl-12 pr-4 py-4 border-2 border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 dark:bg-slate-700 dark:text-white transition-all text-base font-medium">
                        </div>
                        <button onclick="handleSearchClick()"
                            class="px-6 py-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors shadow-md whitespace-nowrap dark:bg-blue-500 dark:hover:bg-blue-600">
                            <i class="fa-solid fa-search mr-2"></i>
                            Search
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                        üí° Or click anywhere on the map to set location
                    </p>
                </div>

                <!-- Selected Location Display -->
                <div id="selectedLocationDisplay"
                    class="flex items-start gap-2 p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
                    <i class="fa-solid fa-location-dot text-green-600 dark:text-green-400 mt-1"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Selected Location:</p>
                        <p id="selectedLocationText" class="text-sm text-slate-600 dark:text-slate-400">Delhi, India</p>
                        <p id="selectedCoordinates" class="text-xs text-slate-500 dark:text-slate-500 mt-1">28.6139¬∞N,
                            77.2090¬∞E</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="confirmLocation()"
                        class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors shadow-md dark:bg-green-500 dark:hover:bg-green-600">
                        <i class="fa-solid fa-check mr-2"></i>
                        Confirm Location
                    </button>
                    <button onclick="requestGeolocation()"
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors shadow-md dark:bg-blue-500 dark:hover:bg-blue-600">
                        <i class="fa-solid fa-crosshairs mr-2"></i>
                        Use My Location
                    </button>
                </div>

                <!-- Help Text -->
                <p class="text-xs text-slate-500 dark:text-slate-400 text-center">
                    üí° Tip: Click anywhere on the map or drag the marker to set your exact farm location
                </p>
            </div>
        </div>
    </div>

</body>

</html>